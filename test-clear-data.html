<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…ç©ºæ•°æ®åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 10px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¸…ç©ºæ•°æ®åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>1. æµ‹è¯•å‰çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkLocalStorage()">æ£€æŸ¥LocalStorageçŠ¶æ€</button>
        <div id="storage-status"></div>
    </div>

    <div class="test-section">
        <h2>2. æ·»åŠ æµ‹è¯•æ•°æ®</h2>
        <button onclick="addTestData()">æ·»åŠ æµ‹è¯•è´¦æˆ·æ•°æ®</button>
        <div id="add-status"></div>
    </div>

    <div class="test-section">
        <h2>3. æ‰§è¡Œæ¸…ç©ºæ•°æ®</h2>
        <button onclick="testClearData()">æµ‹è¯•æ¸…ç©ºæ•°æ®åŠŸèƒ½</button>
        <div id="clear-status"></div>
    </div>

    <div class="test-section">
        <h2>4. éªŒè¯æ¸…ç©ºç»“æœ</h2>
        <button onclick="verifyClearResult()">éªŒè¯æ¸…ç©ºç»“æœ</button>
        <div id="verify-status"></div>
    </div>

    <div class="test-section">
        <h2>5. æµ‹è¯•ä¼šè¯IDé‡ç½®</h2>
        <button onclick="testSessionReset()">æµ‹è¯•ä¼šè¯IDé‡ç½®</button>
        <div id="session-status"></div>
    </div>

    <div id="results"></div>

    <script>
        // æ¨¡æ‹ŸMailManagerçš„éƒ¨åˆ†åŠŸèƒ½è¿›è¡Œæµ‹è¯•
        class TestManager {
            constructor() {
                this.sessionId = null;
                this.accounts = [];
                this.sequenceManager = {
                    sequenceCache: new Map(),
                    maxSequenceCache: 0,
                    initialized: false
                };
                this.loadSession();
                this.loadAccounts();
            }

            loadSession() {
                this.sessionId = localStorage.getItem('mail_manager_session_id');
                if (!this.sessionId) {
                    this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('mail_manager_session_id', this.sessionId);
                }
            }

            loadAccounts() {
                const stored = localStorage.getItem('mailmanager_accounts');
                if (stored) {
                    try {
                        this.accounts = JSON.parse(stored);
                    } catch (error) {
                        this.accounts = [];
                    }
                }
            }

            saveAccounts() {
                localStorage.setItem('mailmanager_accounts', JSON.stringify(this.accounts));
            }

            clearAllData() {
                // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                this.accounts = [];
                this.sequenceManager.sequenceCache.clear();
                this.sequenceManager.maxSequenceCache = 0;
                this.sequenceManager.initialized = false;

                // æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ï¿½ï¿½å‚¨æ•°æ®
                localStorage.removeItem('mailmanager_accounts');
                localStorage.removeItem('mail_manager_session_id');

                // ç”Ÿæˆæ–°çš„ä¼šè¯ID
                this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('mail_manager_session_id', this.sessionId);

                return true;
            }

            addTestAccount() {
                const testAccount = {
                    id: `test_${Date.now()}`,
                    email: `test${this.accounts.length + 1}@outlook.com`,
                    password: 'test_password',
                    client_id: 'test_client_id',
                    refresh_token: 'test_refresh_token',
                    access_token: 'test_access_token',
                    sequence: this.accounts.length + 1,
                    status: 'authorized',
                    created_at: new Date().toISOString(),
                    last_active_at: new Date().toISOString()
                };

                this.accounts.push(testAccount);
                this.saveAccounts();
                return testAccount;
            }
        }

        const testManager = new TestManager();

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="${type}">${message}</span>`;
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function checkLocalStorage() {
            const sessionId = localStorage.getItem('mail_manager_session_id');
            const accounts = localStorage.getItem('mailmanager_accounts');
            const accountsData = accounts ? JSON.parse(accounts) : [];

            updateStatus('storage-status',
                `ä¼šè¯ID: ${sessionId ? sessionId : 'æ— '}<br>` +
                `è´¦æˆ·æ•°é‡: ${accountsData.length}<br>` +
                `è´¦æˆ·æ•°æ®: ${JSON.stringify(accountsData, null, 2)`,
                'info'
            );

            addResult(`æ£€æŸ¥LocalStorageå®Œæˆ - ä¼šè¯ID: ${sessionId ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}, è´¦æˆ·æ•°: ${accountsData.length}`);
        }

        function addTestData() {
            try {
                const account = testManager.addTestAccount();
                updateStatus('add-status', `æˆåŠŸæ·»åŠ æµ‹è¯•è´¦æˆ·: ${account.email}`, 'success');
                addResult(`æ·»åŠ æµ‹è¯•æ•°æ®æˆåŠŸ: ${account.email}`);
            } catch (error) {
                updateStatus('add-status', `æ·»åŠ æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                addResult(`æ·»åŠ æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testClearData() {
            try {
                const beforeSessionId = testManager.sessionId;
                const beforeAccountCount = testManager.accounts.length;

                const success = testManager.clearAllData();

                if (success) {
                    const afterSessionId = testManager.sessionId;
                    const afterAccountCount = testManager.accounts.length;

                    updateStatus('clear-status',
                        `æ¸…ç©ºæ•°æ®æˆåŠŸ!<br>` +
                        `ä¼šè¯ID: ${beforeSessionId} â†’ ${afterSessionId}<br>` +
                        `è´¦æˆ·æ•°é‡: ${beforeAccountCount} â†’ ${afterAccountCount}`,
                        'success'
                    );

                    addResult(`æ¸…ç©ºæ•°æ®åŠŸèƒ½æµ‹è¯•æˆåŠŸ - ä¼šè¯IDå·²é‡ç½®ï¼Œè´¦æˆ·æ•°æ®å·²æ¸…ç©º`);
                } else {
                    throw new Error('æ¸…ç©ºæ•°æ®å¤±è´¥');
                }
            } catch (error) {
                updateStatus('clear-status', `æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                addResult(`æ¸…ç©ºæ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function verifyClearResult() {
            checkLocalStorage();

            const sessionId = localStorage.getItem('mail_manager_session_id');
            const accounts = localStorage.getItem('mailmanager_accounts');
            const accountsData = accounts ? JSON.parse(accounts) : [];

            if (accountsData.length === 0 && sessionId) {
                updateStatus('verify-status', 'âœ… éªŒè¯é€šè¿‡: æ•°æ®å·²å®Œå…¨æ¸…ç©ºï¼Œä¼šè¯IDå·²é‡ç½®', 'success');
                addResult('éªŒè¯ç»“æœ: æ¸…ç©ºæ•°æ®åŠŸèƒ½æ­£å¸¸å·¥ä½œ');
            } else {
                updateStatus('verify-status', 'âŒ éªŒè¯å¤±è´¥: æ•°æ®æœªå®Œå…¨æ¸…ç©º', 'error');
                addResult(`éªŒè¯å¤±è´¥: è´¦æˆ·æ•°=${accountsData.length}, ä¼šè¯ID=${sessionId ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'error');
            }
        }

        function testSessionReset() {
            const oldSessionId = testManager.sessionId;
            testManager.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('mail_manager_session_id', testManager.sessionId);

            updateStatus('session-status',
                `ä¼šè¯IDé‡ç½®æµ‹è¯•<br>` +
                `æ—§ä¼šè¯ID: ${oldSessionId}<br>` +
                `æ–°ä¼šè¯ID: ${testManager.sessionId}`,
                'info'
            );

            addResult(`ä¼šè¯IDé‡ç½®æµ‹è¯•å®Œæˆ: ${oldSessionId} â†’ ${testManager.sessionId}`);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åˆå§‹çŠ¶æ€
        window.onload = function() {
            addResult('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ¸…ç©ºæ•°æ®åŠŸèƒ½æµ‹è¯•');
            checkLocalStorage();
        };
    </script>
</body>
</html>