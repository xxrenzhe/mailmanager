<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>MailManager å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•</h1>

    <div class="test-section">
        <h2>1. æ‰¹é‡å¯¼å…¥åŠŸèƒ½æµ‹è¯•</h2>
        <p>æµ‹è¯•æ‰¹é‡å¯¼å…¥é‚®ç®±åï¼Œæ˜¯å¦è°ƒç”¨åå°å®Œæˆé‚®ç®±æˆæƒã€å–ä»¶ã€éªŒè¯ç æå–</p>
        <button onclick="testBatchImport()">æµ‹è¯•æ‰¹é‡å¯¼å…¥</button>
        <div id="batch-import-result"></div>
    </div>

    <div class="test-section">
        <h2>2. ç‚¹å‡»é‚®ç®±ç›‘æ§åŠŸèƒ½æµ‹è¯•</h2>
        <p>æµ‹è¯•ç‚¹å‡»é‚®ç®±æ˜¯å¦è§¦å‘1åˆ†é’Ÿåå°ç›‘æ§ï¼ˆé‡æ–°æˆæƒã€å–ä»¶ã€æ›´æ–°éªŒè¯ç ï¼‰</p>
        <button onclick="testMonitorTrigger()">æµ‹è¯•ç›‘æ§è§¦å‘</button>
        <div id="monitor-trigger-result"></div>
    </div>

    <div class="test-section">
        <h2>3. WebSocketäº‹ä»¶æµ‹è¯•</h2>
        <p>æµ‹è¯•æ˜¯å¦æ”¶åˆ°å®æ—¶äº‹ä»¶æ¨é€</p>
        <button onclick="testWebSocketEvents()">æµ‹è¯•WebSocketè¿æ¥</button>
        <div id="websocket-result"></div>
    </div>

    <script>
        // æµ‹è¯•1: æ‰¹é‡å¯¼å…¥
        async function testBatchImport() {
            const resultDiv = document.getElementById('batch-import-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æ‰¹é‡å¯¼å…¥...</div>';

            try {
                const response = await fetch('/api/accounts/batch-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: 'test-session-' + Date.now(),
                        emails: [
                            'test1@outlook.com----pass1----client_id_1----refresh_token_1',
                            'test2@outlook.com----pass2----client_id_2----refresh_token_2'
                        ]
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… æ‰¹é‡å¯¼å…¥APIå“åº”æ­£å¸¸</div>
                        <div class="info">
                            <strong>å¤„ç†ç»“æœ:</strong><br>
                            - å¤„ç†æ•°é‡: ${result.processed}<br>
                            - æˆåŠŸæ•°é‡: ${result.success_count}<br>
                            - å¤±è´¥æ•°é‡: ${result.failure_count}<br>
                            - ä¼šè¯ID: ${result.sessionId}<br>
                            - æ¶ˆæ¯: ${result.message}
                        </div>
                        <div class="info">
                            <strong>è¯¦ç»†ç»“æœ:</strong><br>
                            ${result.results.map(r => `- ${r.email}: ${r.success ? 'æˆåŠŸ' : 'å¤±è´¥'} (${r.error || 'æ— é”™è¯¯')}`).join('<br>')}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ æ‰¹é‡å¯¼å…¥å¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æ‰¹é‡å¯¼å…¥è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•2: ç›‘æ§è§¦å‘
        async function testMonitorTrigger() {
            const resultDiv = document.getElementById('monitor-trigger-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•ç›‘æ§è§¦å‘...</div>';

            try {
                const response = await fetch('/api/monitor/copy-trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: 'test-session-' + Date.now(),
                        email_id: 'test-account-123',
                        email: 'test@outlook.com',
                        client_id: 'test_client_id',
                        refresh_token: 'test_refresh_token',
                        current_status: 'pending',
                        codes: [],
                        emails: []
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… ç›‘æ§è§¦å‘æˆåŠŸ</div>
                        <div class="info">
                            <strong>ç›‘æ§è¯¦æƒ…:</strong><br>
                            - é‚®ç®±: ${result.email}<br>
                            - è´¦æˆ·ID: ${result.email_id}<br>
                            - ç›‘æ§æ—¶é•¿: ${result.duration}ms<br>
                            - æ¶ˆæ¯: ${result.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ ç›‘æ§è§¦å‘å¤±è´¥: ${result.error || result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ç›‘æ§è§¦å‘è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•3: WebSocketè¿æ¥
        function testWebSocketEvents() {
            const resultDiv = document.getElementById('websocket-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•WebSocketè¿æ¥...</div>';

            try {
                const sessionId = 'test-session-' + Date.now();
                const wsUrl = `ws://localhost:3002?sessionId=${encodeURIComponent(sessionId)}`;
                const websocket = new WebSocket(wsUrl);

                let connected = false;
                let eventsReceived = [];

                websocket.onopen = () => {
                    connected = true;
                    resultDiv.innerHTML += '<div class="success">âœ… WebSocketè¿æ¥æˆåŠŸ</div>';

                    // è®¢é˜…äº‹ä»¶
                    websocket.send(JSON.stringify({
                        type: 'subscribe',
                        sessionId: sessionId,
                        events: [
                            'verification_code_found',
                            'account_status_changed',
                            'bulk_import_progress',
                            'import_progress',
                            'monitoring_started',
                            'monitoring_ended'
                        ]
                    }));

                    resultDiv.innerHTML += '<div class="info">ğŸ“¡ å·²è®¢é˜…äº‹ä»¶ç±»å‹</div>';
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    eventsReceived.push(data);
                    resultDiv.innerHTML += `<div class="info">ğŸ“¨ æ”¶åˆ°äº‹ä»¶: ${data.type} - ${JSON.stringify(data).substring(0, 100)}...</div>`;
                };

                websocket.onerror = (error) => {
                    resultDiv.innerHTML += `<div class="error">âŒ WebSocketé”™è¯¯: ${error}</div>`;
                };

                websocket.onclose = () => {
                    if (connected) {
                        resultDiv.innerHTML += `<div class="success">âœ… WebSocketè¿æ¥å·²å…³é—­ (æ”¶åˆ° ${eventsReceived.length} ä¸ªäº‹ä»¶)</div>`;
                    } else {
                        resultDiv.innerHTML += '<div class="error">âŒ WebSocketè¿æ¥å¤±è´¥</div>';
                    }
                };

                // 5ç§’åå…³é—­è¿æ¥
                setTimeout(() => {
                    if (websocket.readyState === WebSocket.OPEN) {
                        websocket.close();
                    }
                }, 5000);

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ WebSocketæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        window.onload = async function() {
            try {
                const response = await fetch('/api/health');
                const result = await response.json();

                if (response.ok) {
                    document.body.innerHTML += `
                        <div class="test-section" style="background-color: #d4edda;">
                            <h2>âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸</h2>
                            <p>æœåŠ¡çŠ¶æ€: ${result.status}</p>
                            <p>æ¶æ„: ${result.architecture}</p>
                            <p>WebSocketç«¯å£: ${result.websocket_port}</p>
                            <p>ä»£ç†ç«¯å£: ${result.proxy_port}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.body.innerHTML += `
                    <div class="test-section" style="background-color: #f8d7da;">
                        <h2>âŒ ç³»ç»ŸçŠ¶æ€å¼‚å¸¸</h2>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡: ${error.message}</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>