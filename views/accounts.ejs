<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>账户</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; color: #222; background:#f7f8fa; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn.primary { background:#0b5fff; color:#fff; border-color:#0b5fff; }
    .btn.ghost { background:#f0f3f7; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; background: #fafafa; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    th { text-align: left; color: #666; font-weight: 600; background:#fafbfc; font-size:12px; letter-spacing:.02em; }
    .muted { color: #777; font-size: 12px; }
    .right { margin-left: auto; }
  </style>
  <script>
    async function copyText(text){
      try { await navigator.clipboard.writeText(text); toast('已复制'); }
      catch(e){ console.error(e); toast('复制失败'); }
    }
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.opacity=1; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.opacity=0, 1200); }
    async function pickup(id, btn){
      const b = btn; b.disabled=true; const old=b.textContent; b.textContent='取件中...';
      try{
        const r = await fetch(`/accounts/${id}/pickup`, { method: 'POST' });
        const j = await r.json().catch(()=>({}));
        if (r.ok){ toast('取件成功'); location.reload(); } else { toast('失败: '+(j.message||await r.text())); }
      }catch(e){ toast('网络错误'); }
      finally{ b.disabled=false; b.textContent=old; }
    }
  </script>
  <div id="toast" style="position:fixed;bottom:16px;right:16px;background:#222;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.2s;">已复制</div>
</head>
<body>
  <form class="row card" method="get" action="/" style="background:#fff;border:1px solid #e6e8eb;border-radius:12px;padding:12px;">
    <label>搜索邮箱</label>
    <input type="text" name="q" value="<%= q||'' %>" placeholder="包含关键字" />
    <label>排序</label>
    <select name="sort">
      <option value="import_seq" <%= sort==='import_seq'?'selected':'' %>>导入顺序</option>
      <option value="last_active_at" <%= sort==='last_active_at'?'selected':'' %>>活跃时间</option>
      <option value="email" <%= sort==='email'?'selected':'' %>>邮箱</option>
      <option value="status" <%= sort==='status'?'selected':'' %>>状态</option>
    </select>
    <select name="order">
      <option value="asc" <%= order==='asc'?'selected':'' %>>升序</option>
      <option value="desc" <%= order==='desc'?'selected':'' %>>降序</option>
    </select>
    <button class="btn">应用</button>
    <a class="btn primary" href="/import" style="margin-left:auto;">批量导入邮箱</a>
  </form>

  <div class="row" style="margin-top:8px;">
    <label>批量复制分隔符</label>
    <select id="sep">
      <option value="nl">换行</option>
      <option value="comma">逗号</option>
    </select>
    <button class="btn" onclick="bulkCopy('email')" type="button">批量复制邮箱</button>
    <button class="btn" onclick="bulkCopy('code')" type="button">批量复制最新验证码</button>
  </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" onclick="toggleAll(this)"></th>
        <th>邮箱</th>
        <th>状态</th>
        <th>活跃时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% accounts.forEach(a => { %>
        <tr>
          <td><input type="checkbox" class="rowchk" data-email="<%= a.email %>" data-code="<%= a.latestCode? a.latestCode.code: '' %>"></td>
          <td>
            <div class="row">
              <strong><%= a.email %></strong>
              <button class="btn" type="button" onclick="copyText('<%= a.email %>')">复制邮箱</button>
            </div>
            <div class="muted">ClientID: <%= a.client_id %></div>
            <div>
              最新验证码：
              <% if (a.latestCode) { %>
                <strong><%= a.latestCode.code %></strong>
                <button class="btn" type="button" onclick="copyText('<%= a.latestCode.code %>')">复制验证码</button>
                <span class="muted">(来源:<%= a.latestCode.source||'—' %> 时间:<%= new Date(a.latestCode.received_at).toLocaleString() %>)</span>
              <% } else { %>
                <span class="muted">—</span>
              <% } %>
            </div>
          </td>
          <td><span class="pill"><%= a.status %></span></td>
          <td><%= a.last_active_at ? new Date(a.last_active_at).toLocaleString() : '—' %></td>
          <td>
            <button class="btn" type="button" onclick="pickup('<%= a.id %>', this)">取件</button>
            <button class="btn" type="button" onclick="showRecent('<%= a.id %>')">历史预览</button>
          </td>
        </tr>
        <tr id="recent-<%= a.id %>" style="display:none; background:#fbfbfd;">
          <td></td>
          <td colspan="4">
            <div class="muted">最近 3 条邮件：</div>
            <div id="recent-list-<%= a.id %>" class="row" style="gap:4px; align-items:stretch;">
            </div>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <script>
    function toggleAll(box){ document.querySelectorAll('.rowchk').forEach(c=> c.checked = box.checked); }
    function bulkCopy(field){
      const sep = document.getElementById('sep').value === 'comma' ? ', ' : '\n';
      const sels = Array.from(document.querySelectorAll('.rowchk:checked'));
      const vals = sels.map(x => x.dataset[field]).filter(Boolean);
      if (!vals.length) return toast('未选择行');
      copyText(vals.join(sep));
    }
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); bulkCopy('code'); }
      if (e.key.toLowerCase() === 'c'){ e.preventDefault(); bulkCopy('email'); }
    });

    async function showRecent(id){
      const row = document.getElementById('recent-'+id);
      const box = document.getElementById('recent-list-'+id);
      if (row.style.display === 'none'){
        row.style.display = '';
        box.innerHTML = '<div class="muted">加载中...</div>';
        try {
          const r = await fetch(`/accounts/${id}/recent`);
          const j = await r.json();
          if (!j.ok) throw new Error('加载失败');
          box.innerHTML = j.items.map(m => `
            <div class="card" style="min-width:260px;">
              <div class="muted">${new Date(m.received_at).toLocaleString()}</div>
              <div><strong>${escapeHtml(m.subject||'')}</strong></div>
              <div class="muted">${escapeHtml(m.sender||'')}</div>
              <div class="muted">${escapeHtml((m.preview||'').slice(0,120))}</div>
              <div class="row"><a class="btn" href="#" onclick="openDetail(${id}, '${encodeURIComponent(m.id)}');return false;">查看全文</a></div>
            </div>
          `).join('');
        } catch(e){ box.innerHTML = '<div class="muted">加载失败</div>'; }
      } else {
        row.style.display = 'none';
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    async function openDetail(id, mid){
      const res = await fetch(`/accounts/${id}/messages/${mid}`);
      const j = await res.json();
      if (!j.ok) { alert('加载失败'); return; }
      const m = j.message;
      const html = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
          <div class="card" style="width: min(920px, 96vw); max-height: 80vh; overflow:auto;" onclick="event.stopPropagation()">
            <div class="row" style="justify-content:space-between;">
              <strong>${escapeHtml(m.Subject||'')}</strong>
              <button class="btn" onclick="this.closest('div[style*=position]').remove()">关闭</button>
            </div>
            <div class="muted">${escapeHtml(((m.From && m.From.EmailAddress && m.From.EmailAddress.Address) || ''))} · ${new Date(m.ReceivedDateTime).toLocaleString()}</div>
            <hr />
            <div>
              ${m.Body && m.Body.ContentType === 'HTML' ? m.Body.Content : `<pre style="white-space:pre-wrap">${escapeHtml(m.Body ? m.Body.Content : '')}</pre>`}
            </div>
          </div>
        </div>`;
      const wrap = document.createElement('div');
      wrap.innerHTML = html;
      document.body.appendChild(wrap.firstElementChild);
    }
  </script>
</body>
</html>


