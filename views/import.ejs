<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>导入</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; color: #222; background:#f7f8fa; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn.primary { background:#0b5fff; color:#fff; border-color:#0b5fff; }
    .card { background:#fff;border:1px solid #e6e8eb;border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:12px; }
    textarea { width:100%; min-height:160px; padding:8px; border:1px solid #ddd; border-radius:8px; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
    th,td { padding:8px; border-bottom:1px solid #eee; }
    th { background:#fafbfc; text-align:left; }
    .muted { color:#777; font-size:12px; }
  </style>
</head>
<body>
  <div class="row" style="margin-bottom:12px;"><a class="btn" href="/">← 返回</a><h2 style="margin:0;">批量导入 Outlook 账户</h2></div>
  <div class="card">
    <div class="muted">每行格式：email----password----clientId----codeLike（允许 password 为长横线段）</div>
    <textarea id="raw" placeholder="示例：\nname@outlook.com----xxxx----9e5f...d753----M.Cxxx..."></textarea>
    <div class="row" style="margin-top:8px;">
      <button class="btn" onclick="preview()">预览</button>
      <button class="btn primary" onclick="submitImport()" id="submitBtn" disabled>确认导入</button>
      <span class="muted">仅提交预览中可接受的行</span>
    </div>
  </div>

  <div id="preview" style="margin-top:12px;"></div>

  <script>
  async function preview(){
    const res = await fetch('/accounts/import/preview', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: document.getElementById('raw').value }) });
    const data = await res.json(); renderPreview(data);
  }
  function renderPreview(data){
    const ok = data.rows.filter(r=> r.acceptable).length;
    document.getElementById('submitBtn').disabled = ok===0;
    const rows = data.rows.map(r=> `<tr>
      <td>${r.email||'—'}</td><td>${r.clientId||'—'}</td><td>${r.parseStatus}</td><td>${r.verifyStatus||'—'}</td><td>${r.message||''}</td>
    </tr>`).join('');
    document.getElementById('preview').innerHTML = `
      <div class="card" style="margin-top:8px;">
        可导入：${ok} 条
        <table style="margin-top:8px;">
          <thead><tr><th>邮箱</th><th>ClientID</th><th>解析</th><th>令牌验证</th><th>说明</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    window.__preview = data;
  }
  async function submitImport(){
    const rows = (window.__preview?.rows||[]).filter(r=> r.acceptable).map(r=>({ email:r.email, clientId:r.clientId, codeLike:r.codeLike, importSeq:r.importSeq }));
    const res = await fetch('/accounts/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows }) });
    if (res.ok) { location.href = '/'; } else { alert('导入失败'); }
  }
  </script>
</body>
</html>


