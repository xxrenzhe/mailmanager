<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>è´¦æˆ·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-width: 40px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn.primary {
      background: #007bff;
      color: white;
    }
    .btn:hover {
      opacity: 0.9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      cursor: pointer;
    }
    .muted {
      color: #666;
      font-size: 12px;
    }
    .pill {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      background: #e9ecef;
    }
    .status-authorized {
      background: #d4edda;
      color: #155724;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px;
      background: #28a745;
      color: white;
      border-radius: 4px;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.error {
      background: #dc3545;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    /* ç›‘æ§çŠ¶æ€æ ·å¼ */
    .monitor-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      font-size: 14px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .status-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
      animation: pulse 2s infinite;
    }

    .status-indicator.connected::before {
      background: #28a745;
    }

    .status-indicator.disconnected::before {
      background: #dc3545;
      animation: none;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* æ–°éªŒè¯ç é«˜äº®åŠ¨ç”» */
    .new-codes-detected {
      animation: highlight-new-codes 3s ease-in-out;
    }

    @keyframes highlight-new-codes {
      0% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); }
      50% { box-shadow: 0 0 30px rgba(40, 167, 69, 0.8); }
      100% { box-shadow: none; }
    }

    table.new-codes-detected {
      border: 2px solid #28a745;
      transition: all 0.3s ease;
    }

    table.new-codes-detected td {
      background: rgba(40, 167, 69, 0.05);
    }

    .code-highlight {
      animation: code-glow 2s ease-in-out;
      background: rgba(40, 167, 69, 0.1) !important;
      border: 1px solid #28a745;
      border-radius: 4px;
      padding: 4px 8px;
    }

    @keyframes code-glow {
      0% { background: rgba(40, 167, 69, 0.3); }
      50% { background: rgba(40, 167, 69, 0.5); }
      100% { background: rgba(40, 167, 69, 0.1); }
    }

    /* è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      width: 400px;
      max-width: 90%;
      overflow: hidden;
    }

    .settings-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .settings-body {
      padding: 20px;
    }

    .setting-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .setting-group label {
      font-weight: 500;
      color: #333;
    }

    .setting-group select {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      min-width: 120px;
    }

    /* å¼€å…³æ ·å¼ */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #007bff;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .settings-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* æ™ºèƒ½è§¦å‘è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .smart-trigger-indicator {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h1 style="margin: 0;">é‚®ä»¶è´¦æˆ·ç®¡ç†</h1>
        <div class="row" style="align-items: center; gap: 12px;">
          <!-- ç›‘æ§çŠ¶æ€æŒ‡ç¤ºï¿½ï¿½ï¿½ -->
          <div class="monitor-status">
            <span class="status-indicator" id="connectionStatus">è¿æ¥ä¸­...</span>
            <span class="status-text" id="monitorStats">ç›‘æ§å¯åŠ¨ä¸­...</span>
          </div>

          <!-- æ™ºèƒ½è§¦å‘çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <div class="monitor-status" id="smartTriggerStatus" style="display: none;">
            <span class="status-indicator smart-trigger-indicator" style="background: #ff9500; animation: pulse 2s infinite;"></span>
            <span class="status-text" id="smartTriggerText">æ™ºèƒ½ç›‘æ§ä¸­...</span>
            <button class="btn" onclick="smartTrigger.stop()" title="åœæ­¢æ™ºèƒ½è§¦å‘" style="padding: 4px 8px; font-size: 12px; margin-left: 8px; background: #dc3545; color: white; border: none;">
              åœæ­¢
            </button>
          </div>

          <!-- ç›‘æ§æ§åˆ¶æŒ‰é’® -->
          <button class="btn" onclick="emailMonitor.toggleSound()" title="åˆ‡æ¢æç¤ºéŸ³">
            ğŸ””
          </button>
          <button class="btn" onclick="manualCheck()" title="æ‰‹åŠ¨æ£€æŸ¥é‚®ä»¶">
            ğŸ”„
          </button>
          <button class="btn" onclick="toggleSettings()" title="ç›‘æ§è®¾ç½®">
            âš™ï¸
          </button>
        </div>
      </div>
      <div class="row">
        <input type="text" id="searchInput" value="<%= q || '' %>" placeholder="æœç´¢é‚®ç®±..." style="flex: 1; padding: 8px;">
        <button class="btn primary" onclick="handleSearch()">æœç´¢</button>
        <a href="/import" class="btn" style="background: var(--primary-color, #007bff); color: white; border: none; text-decoration: none; height: 36px; display: inline-flex; align-items: center; justify-content: center;">å¯¼å…¥è´¦æˆ·</a>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
            </th>
            <th onclick="sortBy('email')">é‚®ç®±</th>
            <th onclick="sortBy('status')">çŠ¶æ€</th>
            <th onclick="sortBy('last_active_at')">æ´»è·ƒæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <% accounts.forEach(a => { %>
            <tr>
              <td>
                <input type="checkbox" class="rowchk"
                       data-email="<%= a.email %>"
                       data-code="<%= a.latestCode ? a.latestCode.code : '' %>">
              </td>
              <td>
                <div>
                  <strong
                    style="cursor: pointer; color: #007bff; transition: color 0.2s;"
                    onclick="copyText('<%= a.email %>')"
                    title="ç‚¹å‡»å¤åˆ¶é‚®ç®±åœ°å€"
                    onmouseover="this.style.color='#0056b3'"
                    onmouseout="this.style.color='#007bff'">
                    <%= a.email %>
                  </strong>
                </div>
                <div class="muted">ClientID: <%= a.client_id %></div>
                <% if (a.latestCode) { %>
                  <div style="margin-top: 4px;">
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                      <span style="color: #666; font-size: 12px;">éªŒè¯ç :</span>
                      <span
                        style="color: #28a745; font-weight: bold; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background-color 0.2s; background: rgba(40, 167, 69, 0.05);"
                        onclick="copyText('<%= a.latestCode.code %>')"
                        title="ç‚¹å‡»å¤åˆ¶éªŒè¯ç "
                        onmouseover="this.style.backgroundColor='rgba(40, 167, 69, 0.1)'"
                        onmouseout="this.style.backgroundColor='rgba(40, 167, 69, 0.05)'">
                        <%= a.latestCode.code %>
                      </span>
                      <span style="color: #999; font-size: 11px;">
                        (<%= new Date(a.latestCode.received_at).toLocaleString() %>)
                      </span>
                    </div>
                  </div>
                <% } %>
              </td>
              <td>
                <span class="pill status-<%= a.status %>">
                  <%= a.status === 'authorized' ? 'å·²æˆæƒ' : 'å¾…æˆæƒ' %>
                </span>
              </td>
              <td>
                <%= a.last_active_at ? new Date(a.last_active_at).toLocaleString() : 'â€”' %>
              </td>
              <td>
                <div class="row" style="gap: 4px; flex-wrap: wrap;">
                  <button class="btn primary" onclick="pickup('<%= a.id %>', this)">å–ä»¶</button>
                  <button class="btn" onclick="copyText('<%= a.email %>')" title="å¤åˆ¶é‚®ç®±">å¤åˆ¶é‚®ç®±</button>
                  <% if (a.latestCode) { %>
                    <button class="btn" onclick="copyText('<%= a.latestCode.code %>')" title="å¤åˆ¶éªŒè¯ç ">å¤åˆ¶éªŒè¯ç </button>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <% if (accounts.length === 0) { %>
        <div style="text-align: center; padding: 40px;">
          <h3>æš‚æ— é‚®ç®±è´¦æˆ·</h3>
          <p class="muted"><%= q ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é‚®ç®±è´¦æˆ·' : 'è¯·å…ˆå¯¼å…¥é‚®ç®±è´¦æˆ·' %></p>
          <% if (!q) { %>
            <a href="/import" class="btn primary">ç«‹å³å¯¼å…¥</a>
          <% } %>
        </div>
      <% } %>
    </div>

    <% if (accounts.length > 0) { %>
    <div class="card">
      <div class="row">
        <button class="btn" onclick="bulkCopy('email')">å¤åˆ¶é€‰ä¸­é‚®ç®±</button>
        <button class="btn" onclick="bulkCopy('code')">å¤åˆ¶é€‰ä¸­éªŒè¯ç </button>
        <span class="muted" style="margin-left: auto;">å…± <%= accounts.length %> ä¸ªè´¦æˆ·</span>
      </div>
    </div>
    <% } %>
  </div>

  <div id="notification" class="notification"></div>

  <!-- ç›‘æ§è®¾ç½®é¢æ¿ -->
  <div id="settingsPanel" class="settings-panel" style="display: none;">
    <div class="settings-content">
      <div class="settings-header">
        <h3>ç›‘æ§è®¾ç½®</h3>
        <button class="btn" onclick="toggleSettings()" style="background: none; color: inherit; font-size: 20px;">Ã—</button>
      </div>

      <div class="settings-body">
        <div class="setting-group">
          <label>æ£€æŸ¥é—´éš”</label>
          <select id="checkInterval" onchange="updateCheckInterval()">
            <option value="5000">5ç§’</option>
            <option value="10000">10ç§’</option>
            <option value="30000">30ç§’</option>
            <option value="60000">1åˆ†é’Ÿ</option>
            <option value="300000">5åˆ†é’Ÿ</option>
          </select>
        </div>

        <div class="setting-group">
          <label>å£°éŸ³æé†’</label>
          <div class="toggle-switch">
            <input type="checkbox" id="soundEnabled" onchange="updateSoundSetting()">
            <span class="slider"></span>
          </div>
        </div>

        <div class="setting-group">
          <label>æµè§ˆå™¨é€šçŸ¥</label>
          <div class="toggle-switch">
            <input type="checkbox" id="browserNotification" onchange="updateBrowserNotification()">
            <span class="slider"></span>
          </div>
        </div>

        <div class="setting-group">
          <label>è‡ªåŠ¨åˆ·æ–°</label>
          <div class="toggle-switch">
            <input type="checkbox" id="autoRefresh" onchange="updateAutoRefresh()">
            <span class="slider"></span>
          </div>
        </div>

        <div class="setting-group">
          <label>æ™ºèƒ½è§¦å‘è®¾ç½®</label>
          <div style="margin-top: 10px;">
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: var(--text-secondary);">è§¦å‘æŒç»­æ—¶é—´</label>
              <select id="triggerDuration" onchange="updateTriggerSettings()" style="width: 100%; padding: 6px; border: 1px solid var(--border-light); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                <option value="30000">30ç§’</option>
                <option value="60000" selected>1åˆ†é’Ÿ</option>
                <option value="120000">2åˆ†é’Ÿ</option>
                <option value="300000">5åˆ†é’Ÿ</option>
                <option value="600000">10åˆ†é’Ÿ</option>
              </select>
            </div>
            <div style="margin-bottom: 10px;">
              <label style="font-size: 12px; color: var(--text-secondary);">æ£€æŸ¥é—´éš”</label>
              <select id="triggerInterval" onchange="updateTriggerSettings()" style="width: 100%; padding: 6px; border: 1px solid var(--border-light); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                <option value="3000">3ç§’</option>
                <option value="5000" selected>5ç§’</option>
                <option value="10000">10ç§’</option>
                <option value="15000">15ç§’</option>
                <option value="30000">30ç§’</option>
              </select>
            </div>
            <div>
              <div class="toggle-switch" style="display: inline-block; margin-right: 10px;">
                <input type="checkbox" id="autoStopOnNewCode" checked onchange="updateTriggerSettings()">
                <span class="slider"></span>
              </div>
              <label style="font-size: 12px; color: var(--text-secondary);">æ”¶åˆ°æ–°éªŒè¯ç æ—¶è‡ªåŠ¨åœæ­¢</label>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn" onclick="resetSettings()">é‡ç½®é»˜è®¤</button>
        <button class="btn primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <script>
    // å®æ—¶é‚®ä»¶ç›‘æ§ç³»ç»Ÿ
    class EmailMonitor {
      constructor() {
        this.eventSource = null;
        this.isConnected = false;
        this.newCodesQueue = [];
        this.soundEnabled = true;
        this.initialize();
      }

      initialize() {
        this.connectSSE();
        this.setupNotificationSound();
        this.loadPreferences();
      }

      // è¿æ¥SSE
      connectSSE() {
        try {
          this.eventSource = new EventSource('/events');

          this.eventSource.onopen = () => {
            console.log('[EmailMonitor] SSEè¿æ¥å·²å»ºç«‹');
            this.isConnected = true;
            this.updateConnectionStatus('å·²è¿æ¥');
          };

          this.eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleEvent(data);
          };

          this.eventSource.onerror = (error) => {
            console.error('[EmailMonitor] SSEè¿æ¥é”™è¯¯:', error);
            this.isConnected = false;
            this.updateConnectionStatus('è¿æ¥æ–­å¼€');

            // 5ç§’åå°è¯•é‡è¿
            setTimeout(() => {
              this.connectSSE();
            }, 5000);
          };

        } catch (error) {
          console.error('[EmailMonitor] SSEåˆå§‹åŒ–å¤±è´¥:', error);
          this.updateConnectionStatus('åˆå§‹åŒ–å¤±è´¥');
        }
      }

      // å¤„ç†å®æ—¶äº‹ä»¶
      handleEvent(data) {
        console.log('[EmailMonitor] æ”¶åˆ°äº‹ä»¶:', data);

        switch (data.type) {
          case 'connected':
            showNotification('é‚®ä»¶ç›‘æ§å·²è¿æ¥', 'success');
            break;

          case 'new_codes_detected':
            this.handleNewCodes(data);
            break;

          case 'error':
            showNotification('ç›‘æ§å‡ºé”™: ' + data.error, 'error');
            break;

          case 'heartbeat':
            // å¿ƒè·³äº‹ä»¶ï¼Œç”¨äºä¿æŒè¿æ¥æ´»è·ƒ
            break;
        }
      }

      // å¤„ç†æ–°éªŒè¯ç 
      handleNewCodes(data) {
        const { count, message } = data;

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification(`ğŸ‰ å‘ç° ${count} ä¸ªæ–°éªŒè¯ç ï¼`, 'success');

        // æ’­æ”¾æç¤ºéŸ³
        if (this.soundEnabled) {
          this.playNotificationSound();
        }

        // æ›´æ–°UI
        this.highlightNewCodes();
        this.updateStats();

        // å‘é€æµè§ˆå™¨é€šçŸ¥
        this.sendBrowserNotification(message);
      }

      // çªå‡ºæ˜¾ç¤ºæ–°éªŒè¯ç 
      highlightNewCodes() {
        // æ·»åŠ è§†è§‰åŠ¨ç”»æ•ˆæœ
        const table = document.querySelector('table');
        if (table) {
          table.classList.add('new-codes-detected');
          setTimeout(() => {
            table.classList.remove('new-codes-detected');
          }, 3000);
        }

        // åˆ·æ–°é¡µé¢æ•°æ®ä»¥æ˜¾ç¤ºæ–°éªŒè¯ç 
        setTimeout(() => {
          location.reload();
        }, 1000);
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
      updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
          statusElement.textContent = status;
          statusElement.className = `status-indicator ${this.isConnected ? 'connected' : 'disconnected'}`;
        }
      }

      // è®¾ç½®é€šçŸ¥ï¿½ï¿½æ•ˆ
      setupNotificationSound() {
        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      // æ’­æ”¾æç¤ºéŸ³
      playNotificationSound() {
        try {
          // åˆ›å»ºç®€å•çš„æç¤ºéŸ³
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
          oscillator.frequency.setValueAtTime(1000, this.audioContext.currentTime + 0.1);

          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);

          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + 0.3);
        } catch (error) {
          console.error('[EmailMonitor] æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
        }
      }

      // å‘é€æµè§ˆå™¨é€šçŸ¥
      sendBrowserNotification(message) {
        if (!('Notification' in window)) return;

        if (Notification.permission === 'granted') {
          new Notification('é‚®ä»¶ç®¡ç†å™¨', {
            body: message,
            icon: '/favicon.ico',
            tag: 'new-codes',
            requireInteraction: false
          });
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification('é‚®ä»¶ç®¡ç†å™¨', {
                body: message,
                icon: '/favicon.ico'
              });
            }
          });
        }
      }

      // åŠ è½½ç”¨æˆ·åå¥½
      loadPreferences() {
        const prefs = localStorage.getItem('emailMonitorPrefs');
        if (prefs) {
          try {
            const preferences = JSON.parse(prefs);
            this.soundEnabled = preferences.soundEnabled !== false;
          } catch (error) {
            console.error('[EmailMonitor] åŠ è½½åå¥½è®¾ç½®å¤±è´¥:', error);
          }
        }
      }

      // ä¿å­˜ç”¨æˆ·åå¥½
      savePreferences() {
        const preferences = {
          soundEnabled: this.soundEnabled
        };
        localStorage.setItem('emailMonitorPrefs', JSON.stringify(preferences));
      }

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      updateStats() {
        const statsElement = document.getElementById('monitorStats');
        if (statsElement) {
          // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºç›‘æ§ç»Ÿè®¡ä¿¡æ¯
          statsElement.textContent = 'ç›‘æ§ä¸­...';
        }
      }

      // åˆ‡æ¢å£°éŸ³è®¾ç½®
      toggleSound() {
        this.soundEnabled = !this.soundEnabled;
        this.savePreferences();
        showNotification(
          this.soundEnabled ? 'æç¤ºéŸ³å·²å¼€å¯' : 'æç¤ºéŸ³å·²å…³é—­',
          'info'
        );
      }
    }

    // æ™ºèƒ½è§¦å‘ç›‘æ§ç³»ç»Ÿ
    class SmartTriggerMonitor {
      constructor() {
        this.isTriggering = false;
        this.triggerTimer = null;
        this.checkInterval = null;
        this.currentEmail = null;
        this.triggerDuration = 60000; // é»˜è®¤1åˆ†é’Ÿ
        this.checkIntervalTime = 5000; // é»˜è®¤5ç§’æ£€æŸ¥é—´éš”
        this.lastCodeCount = 0;
        this.settings = this.loadSettings();
      }

      // åŠ è½½ç”¨æˆ·è®¾ç½®
      loadSettings() {
        const saved = localStorage.getItem('smartTriggerSettings');
        return saved ? JSON.parse(saved) : {
          triggerDuration: 60000,
          checkIntervalTime: 5000,
          autoStopOnNewCode: true
        };
      }

      // ä¿å­˜ç”¨æˆ·è®¾ç½®
      saveSettings() {
        localStorage.setItem('smartTriggerSettings', JSON.stringify(this.settings));
        this.triggerDuration = this.settings.triggerDuration;
        this.checkIntervalTime = this.settings.checkIntervalTime;
      }

      // ä»é‚®ç®±å¤åˆ¶å¼€å§‹æŒç»­è§¦å‘
      startContinuousTriggerFromEmail(email) {
        if (this.isTriggering) {
          console.log('[SmartTrigger] è§¦å‘å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è§¦å‘');
          return;
        }

        this.currentEmail = email;
        this.isTriggering = true;
        this.lastCodeCount = this.getCurrentCodeCount();

        console.log(`[SmartTrigger] å¼€å§‹ç›‘æ§é‚®ç®±: ${email}`);
        showNotification(`å¼€å§‹ç›‘æ§ ${email} çš„æ–°é‚®ä»¶`, 'info');

        // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
        this.showStatusIndicator(`ç›‘æ§é‚®ç®±: ${email}`);

        // å¯åŠ¨å®šæ—¶æ£€æŸ¥
        this.startPeriodicCheck();

        // è®¾ç½®è§¦å‘è¶…æ—¶
        this.triggerTimer = setTimeout(() => {
          this.stopTrigger('ç›‘æ§æ—¶é—´å·²ç»“æŸ');
        }, this.triggerDuration);
      }

      // ä»æ”¶ä»¶æŒ‰é’®å¼€å§‹è§¦å‘
      startTriggerFromPickup(accountId) {
        if (this.isTriggering) {
          console.log('[SmartTrigger] è§¦å‘å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è§¦å‘');
          return;
        }

        this.isTriggering = true;
        this.lastCodeCount = this.getCurrentCodeCount();
        this.currentAccountId = accountId;

        console.log(`[SmartTrigger] å¼€å§‹ç›‘æ§è´¦æˆ·: ${accountId}`);
        showNotification('å¼€å§‹ç›‘æ§æ–°éªŒè¯ç ', 'info');

        // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
        this.showStatusIndicator('ç›‘æ§æ–°éªŒè¯ç ');

        // å¯åŠ¨å®šæ—¶æ£€æŸ¥
        this.startPeriodicCheck();

        // è®¾ç½®è§¦å‘è¶…æ—¶
        this.triggerTimer = setTimeout(() => {
          this.stopTrigger('ç›‘æ§æ—¶é—´å·²ç»“æŸ');
        }, this.triggerDuration);
      }

      // å¯åŠ¨å®šæœŸæ£€æŸ¥
      startPeriodicCheck() {
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
        if (this.checkInterval) {
          clearInterval(this.checkInterval);
        }

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
        this.performCheck();

        // è®¾ç½®å®šæœŸæ£€æŸ¥
        this.checkInterval = setInterval(() => {
          this.performCheck();
        }, this.checkIntervalTime);
      }

      // æ‰§è¡Œæ£€æŸ¥
      async performCheck() {
        try {
          let response;

          if (this.currentEmail) {
            // åŸºäºé‚®ç®±çš„æ£€æŸ¥
            response = await fetch(`/api/check-email-now?email=${encodeURIComponent(this.currentEmail)}`, {
              method: 'POST'
            });
          } else if (this.currentAccountId) {
            // åŸºäºè´¦æˆ·IDçš„æ£€æŸ¥
            response = await fetch(`/accounts/${this.currentAccountId}/check-now`, {
              method: 'POST'
            });
          }

          if (response && response.ok) {
            const result = await response.json();
            console.log('[SmartTrigger] æ£€æŸ¥ç»“æœ:', result);

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„éªŒè¯ç 
            if (this.settings.autoStopOnNewCode && this.checkForNewCodes()) {
              this.stopTrigger('æ£€æµ‹åˆ°æ–°éªŒè¯ç ');
              // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°éªŒè¯ç 
              setTimeout(() => location.reload(), 1000);
              return;
          }

            if (result.newMessages) {
              showNotification(`å‘ç° ${result.newMessages} å°æ–°é‚®ä»¶`, 'success');
            }
          }
        } catch (error) {
          console.error('[SmartTrigger] æ£€æŸ¥å¤±è´¥:', error);
        }
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„éªŒè¯ç 
      checkForNewCodes() {
        const currentCount = this.getCurrentCodeCount();
        if (currentCount > this.lastCodeCount) {
          console.log(`[SmartTrigger] å‘ç°æ–°éªŒè¯ç : ${this.lastCodeCount} â†’ ${currentCount}`);
          return true;
        }
        return false;
      }

      // è·å–å½“å‰éªŒè¯ç æ•°é‡
      getCurrentCodeCount() {
        const codeElements = document.querySelectorAll('[data-code]');
        let count = 0;
        codeElements.forEach(element => {
          const code = element.getAttribute('data-code');
          if (code && /^\d+$/.test(code)) {
            count++;
          }
        });
        return count;
      }

      // åœæ­¢è§¦å‘
      stopTrigger(reason = 'æ‰‹åŠ¨åœæ­¢') {
        if (!this.isTriggering) {
          return;
        }

        console.log(`[SmartTrigger] åœæ­¢è§¦å‘: ${reason}`);

        this.isTriggering = false;
        this.currentEmail = null;
        this.currentAccountId = null;

        // æ¸…é™¤å®šæ—¶å™¨
        if (this.triggerTimer) {
          clearTimeout(this.triggerTimer);
          this.triggerTimer = null;
        }

        if (this.checkInterval) {
          clearInterval(this.checkInterval);
          this.checkInterval = null;
        }

        // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
        this.hideStatusIndicator();

        showNotification(`ç›‘æ§å·²åœæ­¢: ${reason}`, 'info');
      }

      // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
      showStatusIndicator(text) {
        const statusEl = document.getElementById('smartTriggerStatus');
        const textEl = document.getElementById('smartTriggerText');
        if (statusEl && textEl) {
          textEl.textContent = text;
          statusEl.style.display = 'flex';
        }
      }

      // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
      hideStatusIndicator() {
        const statusEl = document.getElementById('smartTriggerStatus');
        if (statusEl) {
          statusEl.style.display = 'none';
        }
      }

      // æ‰‹åŠ¨åœæ­¢
      stop() {
        this.stopTrigger('ç”¨æˆ·æ‰‹åŠ¨åœæ­¢');
      }

      // æ›´æ–°è®¾ç½®
      updateSettings(newSettings) {
        this.settings = { ...this.settings, ...newSettings };
        this.saveSettings();
        showNotification('è§¦å‘è®¾ç½®å·²ä¿å­˜', 'success');
      }

      // è·å–å½“å‰çŠ¶æ€
      getStatus() {
        return {
          isTriggering: this.isTriggering,
          currentEmail: this.currentEmail,
          currentAccountId: this.currentAccountId,
          remainingTime: this.triggerTimer ? this.triggerDuration - (Date.now() - this.startTime) : 0,
          settings: this.settings
        };
      }
    }

    // å…¨å±€å®ä¾‹
    const emailMonitor = new EmailMonitor();
    const smartTrigger = new SmartTriggerMonitor();

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

        // å¦‚æœå¤åˆ¶çš„æ˜¯é‚®ç®±ï¼Œè§¦å‘æŒç»­ç›‘æ§
        if (text && text.includes('@')) {
          smartTrigger.startContinuousTriggerFromEmail(text);
        }
      }).catch(() => {
        showNotification('å¤åˆ¶å¤±è´¥', 'error');
      });
    }

    function pickup(id, btn) {
      btn.disabled = true;
      btn.textContent = 'å–ä»¶ä¸­...';

      fetch(`/accounts/${id}/pickup`, { method: 'POST' })
        .then(r => r.json())
        .then(j => {
          if (j.ok) {
            showNotification('å–ä»¶æˆåŠŸ');

            // å¯åŠ¨æ™ºèƒ½è§¦å‘ç›‘æ§
            smartTrigger.startTriggerFromPickup(id);

            setTimeout(() => location.reload(), 1500);
          } else {
            showNotification('å–ä»¶å¤±è´¥: ' + (j.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(e => {
          showNotification('ç½‘ç»œé”™è¯¯', 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = 'å–ä»¶';
        });
    }

    function sortBy(field) {
      const currentSort = '<%= sort %>';
      const currentOrder = '<%= order %>';
      const newOrder = (currentSort === field && currentOrder === 'asc') ? 'desc' : 'asc';

      window.location.href = `/?sort=${field}&order=${newOrder}&q=<%= q %>`;
    }

    function handleSearch() {
      const query = document.getElementById('searchInput').value;
      window.location.href = `/?q=${encodeURIComponent(query)}`;
    }

    function toggleAll(checkbox) {
      document.querySelectorAll('.rowchk').forEach(cb => cb.checked = checkbox.checked);
    }

    function bulkCopy(field) {
      const selected = document.querySelectorAll('.rowchk:checked');
      const values = Array.from(selected).map(cb => cb.dataset[field]).filter(Boolean);

      if (values.length === 0) {
        showNotification('è¯·é€‰æ‹©è¦å¤åˆ¶çš„å†…å®¹', 'error');
        return;
      }

      copyText(values.join('\n'));
    }

    // æ‰‹åŠ¨æ£€æŸ¥é‚®ä»¶
    function manualCheck() {
      const btn = event.target;
      const originalText = btn.innerHTML;

      btn.disabled = true;
      btn.innerHTML = 'ğŸ”„ æ£€æŸ¥ä¸­...';

      fetch('/api/monitor/check', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            showNotification(`é‚®ä»¶æ£€æŸ¥å®Œæˆï¼Œå‘ç° ${data.newCodesCount || 0} ä¸ªæ–°éªŒè¯ç `, 'success');
            if (data.newCodesCount > 0) {
              setTimeout(() => location.reload(), 1500);
            }
          } else {
            showNotification('æ£€æŸ¥å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(e => {
          console.error('Manual check error:', e);
          showNotification('ç½‘ç»œé”™è¯¯', 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
    }

    // è®¾ç½®é¢æ¿åŠŸèƒ½
  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    if (panel.style.display === 'none') {
      loadSettings();
      panel.style.display = 'flex';
    } else {
      panel.style.display = 'none';
    }
  }

  function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('monitorSettings') || '{}');

    // è®¾ç½®æ£€æŸ¥é—´éš”
    document.getElementById('checkInterval').value = settings.checkInterval || '5000';

    // è®¾ç½®å£°éŸ³å¼€å…³
    document.getElementById('soundEnabled').checked = settings.soundEnabled !== false;

    // è®¾ç½®æµè§ˆå™¨é€šçŸ¥
    document.getElementById('browserNotification').checked = settings.browserNotification !== false;

    // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
    document.getElementById('autoRefresh').checked = settings.autoRefresh !== false;
  }

  function saveSettings() {
    const settings = {
      checkInterval: document.getElementById('checkInterval').value,
      soundEnabled: document.getElementById('soundEnabled').checked,
      browserNotification: document.getElementById('browserNotification').checked,
      autoRefresh: document.getElementById('autoRefresh').checked
    };

    localStorage.setItem('monitorSettings', JSON.stringify(settings));

    // åº”ç”¨è®¾ç½®
    applySettings(settings);

    showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
    toggleSettings();
  }

  function applySettings(settings) {
    // æ›´æ–°æ£€æŸ¥é—´éš”
    if (settings.checkInterval) {
      fetch('/api/monitor/interval', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interval: parseInt(settings.checkInterval) })
      });
    }

    // æ›´æ–°å£°éŸ³è®¾ç½®
    if (typeof emailMonitor !== 'undefined') {
      emailMonitor.soundEnabled = settings.soundEnabled !== false;
    }

    // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
    if (settings.browserNotification && 'Notification' in window) {
      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
  }

  function resetSettings() {
    localStorage.removeItem('monitorSettings');
    loadSettings();
    showNotification('è®¾ç½®å·²é‡ç½®', 'info');
  }

  function updateCheckInterval() {
    const interval = document.getElementById('checkInterval').value;
    fetch('/api/monitor/interval', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ interval: parseInt(interval) })
    }).then(() => {
      showNotification('æ£€æŸ¥é—´éš”å·²æ›´æ–°', 'success');
    });
  }

  function updateSoundSetting() {
    const enabled = document.getElementById('soundEnabled').checked;
    if (typeof emailMonitor !== 'undefined') {
      emailMonitor.soundEnabled = enabled;
    }

    const settings = JSON.parse(localStorage.getItem('monitorSettings') || '{}');
    settings.soundEnabled = enabled;
    localStorage.setItem('monitorSettings', JSON.stringify(settings));
  }

  function updateBrowserNotification() {
    const enabled = document.getElementById('browserNotification').checked;
    if (enabled && 'Notification' in window) {
      if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            showNotification('æµè§ˆå™¨é€šçŸ¥å·²å¼€å¯', 'success');
          } else {
            showNotification('æµè§ˆå™¨é€šçŸ¥æƒé™è¢«æ‹’ç»', 'error');
            document.getElementById('browserNotification').checked = false;
          }
        });
      }
    }

    const settings = JSON.parse(localStorage.getItem('monitorSettings') || '{}');
    settings.browserNotification = enabled;
    localStorage.setItem('monitorSettings', JSON.stringify(settings));
  }

  function updateAutoRefresh() {
    const enabled = document.getElementById('autoRefresh').checked;
    const settings = JSON.parse(localStorage.getItem('monitorSettings') || '{}');
    settings.autoRefresh = enabled;
    localStorage.setItem('monitorSettings', JSON.stringify(settings));

    showNotification(`è‡ªåŠ¨åˆ·æ–°å·²${enabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
  }

  function updateTriggerSettings() {
    const duration = parseInt(document.getElementById('triggerDuration').value);
    const interval = parseInt(document.getElementById('triggerInterval').value);
    const autoStop = document.getElementById('autoStopOnNewCode').checked;

    if (typeof smartTrigger !== 'undefined') {
      smartTrigger.updateSettings({
        triggerDuration: duration,
        checkIntervalTime: interval,
        autoStopOnNewCode: autoStop
      });
    }

    showNotification('è§¦å‘è®¾ç½®å·²æ›´æ–°', 'info');
  }

  // å›è½¦æœç´¢
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleSearch();
      }
    });
  </script>
</body>
</html>