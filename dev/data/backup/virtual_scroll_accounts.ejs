<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>è´¦æˆ· - é«˜æ€§èƒ½ç‰ˆæœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-width: 40px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn.primary {
      background: #007bff;
      color: white;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* è™šæ‹Ÿæ»šåŠ¨å®¹å™¨ */
    .virtual-scroll-container {
      height: 600px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: white;
    }

    .virtual-scroll-content {
      position: relative;
      overflow-y: auto;
      height: 100%;
    }

    .virtual-scroll-spacer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      pointer-events: none;
    }

    .virtual-scroll-items {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .virtual-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .virtual-table th,
    .virtual-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .virtual-table th {
      background: #f8f9fa;
      font-weight: 600;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .virtual-table th:nth-child(1) { width: 40px; }  /* checkbox */
    .virtual-table th:nth-child(2) { width: 300px; } /* email */
    .virtual-table th:nth-child(3) { width: 100px; } /* status */
    .virtual-table th:nth-child(4) { width: 150px; } /* last active */
    .virtual-table th:nth-child(5) { width: 200px; } /* actions */

    .muted {
      color: #666;
      font-size: 12px;
    }
    .pill {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      background: #e9ecef;
    }
    .status-authorized {
      background: #d4edda;
      color: #155724;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px;
      background: #28a745;
      color: white;
      border-radius: 4px;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.error {
      background: #dc3545;
    }
    .notification.info {
      background: #17a2b8;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ç»Ÿè®¡ä¿¡æ¯ */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .stats-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stats-value {
      font-weight: bold;
      color: #007bff;
    }

    /* æœç´¢è¿‡æ»¤ */
    .filter-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-bar input {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .filter-bar select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
    }

    /* æ€§èƒ½æŒ‡æ ‡ */
    .performance-metrics {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: monospace;
      z-index: 1000;
    }

    /* æŒ‰éœ€ç›‘æ§æ ·å¼ */
    .monitor-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      font-size: 14px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .status-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
      animation: pulse 2s infinite;
    }

    .status-indicator.monitoring::before {
      background: #28a745;
    }

    .status-indicator.idle::before {
      background: #ffc107;
      animation: none;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* ç›‘æ§é«˜äº® */
    .monitoring-active {
      animation: monitoring-pulse 2s ease-in-out;
      background: rgba(40, 167, 69, 0.05) !important;
    }

    @keyframes monitoring-pulse {
      0% { background: rgba(40, 167, 69, 0.05); }
      50% { background: rgba(40, 167, 69, 0.1); }
      100% { background: rgba(40, 167, 69, 0.05); }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-bar input {
        min-width: auto;
      }

      .virtual-table th:nth-child(4),
      .virtual-table td:nth-child(4) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h1 style="margin: 0;">é‚®ä»¶è´¦æˆ·ç®¡ç† - é«˜æ€§èƒ½ç‰ˆ</h1>
        <div class="row" style="align-items: center; gap: 12px;">
          <div class="monitor-status">
            <span class="status-indicator idle" id="systemStatus">ç³»ç»Ÿç©ºé—²</span>
            <span class="status-text" id="systemStats">æŒ‰éœ€ç›‘æ§æ¨¡å¼</span>
          </div>
          <button class="btn" onclick="togglePerformanceMetrics()" title="æ€§èƒ½æŒ‡æ ‡">
            ğŸ“ˆ
          </button>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯æ  -->
      <div class="stats-bar">
        <div class="stats-item">
          <span>æ€»è´¦æˆ·:</span>
          <span class="stats-value" id="totalAccounts">-</span>
        </div>
        <div class="stats-item">
          <span>å·²æˆæƒ:</span>
          <span class="stats-value" id="authorizedAccounts">-</span>
        </div>
        <div class="stats-item">
          <span>å¾…æˆæƒ:</span>
          <span class="stats-value" id="pendingAccounts">-</span>
        </div>
        <div class="stats-item">
          <span>å½“å‰æ˜¾ç¤º:</span>
          <span class="stats-value" id="visibleAccounts">-</span>
        </div>
        <div class="stats-item">
          <span>æ´»è·ƒç›‘æ§:</span>
          <span class="stats-value" id="activeMonitors">0</span>
        </div>
      </div>

      <!-- æœç´¢è¿‡æ»¤æ  -->
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢é‚®ç®±..." />
        <select id="statusFilter">
          <option value="">æ‰€æœ‰çŠ¶æ€</option>
          <option value="authorized">å·²æˆæƒ</option>
          <option value="pending">å¾…æˆæƒ</option>
        </select>
        <select id="sortBy">
          <option value="last_active_at">æœ€åæ´»è·ƒæ—¶é—´</option>
          <option value="email">é‚®ç®±åœ°å€</option>
          <option value="created_at">åˆ›å»ºæ—¶é—´</option>
          <option value="total_codes">éªŒè¯ç æ•°é‡</option>
        </select>
        <select id="sortOrder">
          <option value="desc">é™åº</option>
          <option value="asc">å‡åº</option>
        </select>
        <button class="btn primary" onclick="applyFilters()">åº”ç”¨è¿‡æ»¤</button>
        <a href="/import" class="btn" style="background: var(--primary-color, #007bff); color: white; border: none; text-decoration: none; height: 36px; display: inline-flex; align-items: center; justify-content: center;">å¯¼å…¥è´¦æˆ·</a>
      </div>
    </div>

    <!-- è™šæ‹Ÿæ»šåŠ¨è¡¨æ ¼ -->
    <div class="card">
      <div class="virtual-scroll-container" id="virtualScrollContainer">
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
          <div class="loading-spinner"></div>
        </div>

        <div class="virtual-scroll-content" id="virtualScrollContent">
          <div class="virtual-scroll-spacer" id="scrollSpacer"></div>
          <div class="virtual-scroll-items" id="scrollItems">
            <!-- è¡¨å¤´ -->
            <table class="virtual-table">
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
                  </th>
                  <th onclick="changeSort('email')">é‚®ç®± â†•</th>
                  <th onclick="changeSort('status')">çŠ¶æ€ â†•</th>
                  <th onclick="changeSort('last_active_at')">æ´»è·ƒæ—¶é—´ â†•</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
            </table>

            <!-- åŠ¨æ€å†…å®¹å®¹å™¨ -->
            <div id="dynamicContent"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button class="btn" onclick="bulkCopy('email')">å¤åˆ¶é€‰ä¸­é‚®ç®±</button>
        <button class="btn" onclick="bulkCopy('code')">å¤åˆ¶é€‰ä¸­éªŒè¯ç </button>
        <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        <span class="muted" style="margin-left: auto;">
          æ¸²æŸ“æ—¶é—´: <span id="renderTime">0ms</span> |
          å†…å­˜ä½¿ç”¨: <span id="memoryUsage">0MB</span>
        </span>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>
  <div class="performance-metrics" id="performanceMetrics" style="display: none;">
    <div>FPS: <span id="fps">60</span></div>
    <div>æ¸²æŸ“è¡Œæ•°: <span id="renderedRows">0</span></div>
    <div>æ€»è¡Œæ•°: <span id="totalRows">0</span></div>
    <div>æ»šåŠ¨ä½ç½®: <span id="scrollPosition">0</span></div>
  </div>

  <script>
    // è™šæ‹Ÿæ»šåŠ¨å®ç°
    class VirtualScroll {
      constructor(options) {
        this.container = options.container;
        this.content = options.content;
        this.spacer = options.spacer;
        this.items = options.items;
        this.itemHeight = options.itemHeight || 60;
        this.bufferSize = options.bufferSize || 10;
        this.visibleItems = [];
        this.allItems = [];
        this.filteredItems = [];
        this.isLoading = false;

        // æ€§èƒ½ç›‘æ§
        this.lastRenderTime = 0;
        this.renderCount = 0;
        this.fps = 60;
        this.lastFrameTime = performance.now();

        this.init();
      }

      init() {
        this.setupScrollListener();
        this.setupResizeListener();
        this.startFPSMonitoring();
      }

      // è®¾ç½®æ•°æ®
      setData(items) {
        this.allItems = items;
        this.filteredItems = [...items];
        this.updateSpacer();
        this.render();
      }

      // è¿‡æ»¤æ•°æ®
      filterData(filters) {
        const startTime = performance.now();

        this.filteredItems = this.allItems.filter(item => {
          if (filters.email && !item.email.toLowerCase().includes(filters.email.toLowerCase())) {
            return false;
          }
          if (filters.status && item.status !== filters.status) {
            return false;
          }
          return true;
        });

        // æ’åº
        if (filters.sortBy) {
          this.filteredItems.sort((a, b) => {
            let av = a[filters.sortBy] || '';
            let bv = b[filters.sortBy] || '';

            // æ—¥æœŸå­—æ®µç‰¹æ®Šå¤„ç†
            if (['last_active_at', 'created_at'].includes(filters.sortBy)) {
              av = av ? new Date(av).getTime() : 0;
              bv = bv ? new Date(bv).getTime() : 0;
            }

            if (av === bv) return 0;
            return filters.sortOrder === 'asc' ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
          });
        }

        this.updateSpacer();
        this.render();

        const endTime = performance.now();
        console.log(`[VirtualScroll] è¿‡æ»¤è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms, ç»“æœ: ${this.filteredItems.length} æ¡`);
      }

      // æ›´æ–°å ä½ç©ºé—´é«˜åº¦
      updateSpacer() {
        const totalHeight = this.filteredItems.length * this.itemHeight;
        this.spacer.style.height = `${totalHeight}px`;

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        document.getElementById('totalRows').textContent = this.filteredItems.length;
      }

      // è®¾ç½®æ»šåŠ¨ç›‘å¬
      setupScrollListener() {
        this.content.addEventListener('scroll', () => {
          this.handleScroll();
        });
      }

      // è®¾ç½®çª—å£å¤§å°ç›‘å¬
      setupResizeListener() {
        window.addEventListener('resize', () => {
          this.render();
        });
      }

      // å¤„ç†æ»šåŠ¨
      handleScroll() {
        if (this.isLoading) return;

        requestAnimationFrame(() => {
          this.render();
        });
      }

      // æ¸²æŸ“å¯è§é¡¹ç›®
      render() {
        const startTime = performance.now();

        const containerHeight = this.container.clientHeight;
        const scrollTop = this.content.scrollTop;

        // è®¡ç®—å¯è§èŒƒå›´
        const startIndex = Math.max(0, Math.floor(scrollTop / this.itemHeight) - this.bufferSize);
        const endIndex = Math.min(
          this.filteredItems.length - 1,
          Math.ceil((scrollTop + containerHeight) / this.itemHeight) + this.bufferSize
        );

        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
        if (this.visibleItems.length > 0) {
          const firstVisibleIndex = this.visibleItems[0].index;
          const lastVisibleIndex = this.visibleItems[this.visibleItems.length - 1].index;

          if (startIndex >= firstVisibleIndex - this.bufferSize/2 &&
              endIndex <= lastVisibleIndex + this.bufferSize/2) {
            // åœ¨ç¼“å†²åŒºå†…ï¼Œä¸éœ€è¦é‡æ–°æ¸²æŸ“
            return;
          }
        }

        // åˆ›å»ºå¯è§é¡¹ç›®
        const newVisibleItems = [];
        for (let i = startIndex; i <= endIndex; i++) {
          const item = this.filteredItems[i];
          if (item) {
            newVisibleItems.push({
              ...item,
              index: i,
              top: i * this.itemHeight
            });
          }
        }

        // æ›´æ–°DOM
        this.renderItems(newVisibleItems);
        this.visibleItems = newVisibleItems;

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        const endTime = performance.now();
        this.lastRenderTime = endTime - startTime;
        this.renderCount++;

        document.getElementById('renderTime').textContent = `${this.lastRenderTime.toFixed(1)}ms`;
        document.getElementById('renderedRows').textContent = newVisibleItems.length;
        document.getElementById('scrollPosition').textContent = Math.round(scrollTop);
        document.getElementById('visibleAccounts').textContent = newVisibleItems.length;

        if (this.renderCount % 60 === 0) {
          console.log(`[VirtualScroll] æ¸²æŸ“æ€§èƒ½: ${this.lastRenderTime.toFixed(2)}ms, è¡Œæ•°: ${newVisibleItems.length}`);
        }
      }

      // æ¸²æŸ“é¡¹ç›®åˆ°DOM
      renderItems(items) {
        const container = document.getElementById('dynamicContent');
        const fragment = document.createDocumentFragment();

        // æ¸…ç©ºç°æœ‰å†…å®¹
        container.innerHTML = '';

        items.forEach(item => {
          const row = this.createAccountRow(item);
          fragment.appendChild(row);
        });

        container.appendChild(fragment);
      }

      // åˆ›å»ºè´¦æˆ·è¡Œ
      createAccountRow(item) {
        const row = document.createElement('div');
        row.className = 'account-row';
        row.style.cssText = `
          position: absolute;
          top: ${item.top}px;
          left: 0;
          right: 0;
          height: ${this.itemHeight}px;
          display: flex;
          align-items: center;
          padding: 0 12px;
          border-bottom: 1px solid #eee;
          background: white;
          ${item.monitoringActive ? 'background: rgba(40, 167, 69, 0.05);' : ''}
        `;

        row.dataset.accountId = item.id;
        row.dataset.email = item.email;

        row.innerHTML = `
          <div style="width: 40px;">
            <input type="checkbox" class="rowchk"
                   data-email="${item.email}"
                   data-code="${item.latestCode ? item.latestCode.code : ''}">
          </div>
          <div style="width: 300px; padding: 0 12px; overflow: hidden;">
            <div style="font-weight: 500; color: #007bff; cursor: pointer;"
                 onclick="copyText('${item.email}')" title="ç‚¹å‡»å¤åˆ¶é‚®ç®±">
              ${item.email}
            </div>
            <div class="muted" style="font-size: 11px;">ClientID: ${item.client_id}</div>
            ${item.latestCode ? `
              <div style="margin-top: 4px;">
                <span style="color: #28a745; font-weight: bold; cursor: pointer; padding: 2px 6px; border-radius: 4px; background: rgba(40, 167, 69, 0.05);"
                      onclick="copyText('${item.latestCode.code}')" title="ç‚¹å‡»å¤åˆ¶éªŒè¯ç ">
                  ${item.latestCode.code}
                </span>
                <span style="color: #999; font-size: 11px; margin-left: 4px;">
                  (${new Date(item.latestCode.received_at).toLocaleString()})
                </span>
              </div>
            ` : ''}
          </div>
          <div style="width: 100px;">
            <span class="pill status-${item.status}">
              ${item.status === 'authorized' ? 'å·²æˆæƒ' : 'å¾…æˆæƒ'}
            </span>
          </div>
          <div style="width: 150px; color: #666; font-size: 13px;">
            ${item.last_active_at ? new Date(item.last_active_at).toLocaleString() : 'â€”'}
          </div>
          <div style="width: 200px;">
            <div style="display: flex; gap: 4px;">
              <button class="btn primary" onclick="pickup(${item.id}, this)" style="padding: 4px 8px; font-size: 12px;">
                å–ä»¶
              </button>
              <button class="btn" onclick="copyText('${item.email}')" title="å¤åˆ¶é‚®ç®±" style="padding: 4px 8px; font-size: 12px;">
                å¤åˆ¶é‚®ç®±
              </button>
              ${item.latestCode ? `
                <button class="btn" onclick="copyText('${item.latestCode.code}')" title="å¤åˆ¶éªŒè¯ç " style="padding: 4px 8px; font-size: 12px;">
                  å¤åˆ¶éªŒè¯ç 
                </button>
              ` : ''}
            </div>
          </div>
        `;

        return row;
      }

      // FPSç›‘æ§
      startFPSMonitoring() {
        const updateFPS = () => {
          const now = performance.now();
          const delta = now - this.lastFrameTime;
          this.fps = Math.round(1000 / delta);
          this.lastFrameTime = now;

          document.getElementById('fps').textContent = this.fps;

          requestAnimationFrame(updateFPS);
        };
        requestAnimationFrame(updateFPS);
      }

      // æ»šåŠ¨åˆ°æŒ‡å®šé¡¹ç›®
      scrollToItem(index) {
        const scrollTop = index * this.itemHeight;
        this.content.scrollTop = scrollTop;
      }

      // è·å–å¯è§é¡¹ç›®
      getVisibleItems() {
        return this.visibleItems;
      }

      // åˆ·æ–°æ•°æ®
      refresh() {
        this.render();
      }

      // é”€æ¯
      destroy() {
        this.content.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.render);
      }
    }

    // æ•°æ®ç®¡ç†å™¨
    class DataManager {
      constructor() {
        this.cache = new Map();
        this.cacheTimeout = 30000; // 30ç§’ç¼“å­˜
        this.pageSize = 100; // æ¯æ¬¡åŠ è½½100æ¡
      }

      async loadAccounts(page = 1, filters = {}) {
        const cacheKey = `accounts_${page}_${JSON.stringify(filters)}`;
        const cached = this.cache.get(cacheKey);

        if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
          return cached.data;
        }

        this.showLoading(true);

        try {
          const params = new URLSearchParams({
            page,
            size: this.pageSize,
            sort: filters.sortBy || 'last_active_at',
            order: filters.sortOrder || 'desc',
            q: filters.email || ''
          });

          const response = await fetch(`/api/accounts/paged?${params}`);
          const data = await response.json();

          // ç¼“å­˜ç»“æœ
          this.cache.set(cacheKey, {
            data,
            timestamp: Date.now()
          });

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          this.updateStats(data);

          return data;
        } catch (error) {
          console.error('[DataManager] åŠ è½½æ•°æ®å¤±è´¥:', error);
          throw error;
        } finally {
          this.showLoading(false);
        }
      }

      updateStats(data) {
        document.getElementById('totalAccounts').textContent = data.total || 0;
        document.getElementById('authorizedAccounts').textContent = data.authorized || 0;
        document.getElementById('pendingAccounts').textContent = data.pending || 0;

        // æ›´æ–°å†…å­˜ä½¿ç”¨æƒ…å†µ
        if (performance.memory) {
          const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
          document.getElementById('memoryUsage').textContent = `${memoryMB}MB`;
        }
      }

      showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      }

      clearCache() {
        this.cache.clear();
      }
    }

    // æŒ‰éœ€ç›‘æ§å®¢æˆ·ç«¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
    class OnDemandMonitorClient {
      constructor() {
        this.activeMonitors = new Map();
        this.eventSources = new Map();
      }

      async startAccountMonitor(accountId, accountEmail) {
        try {
          const response = await fetch(`/accounts/${accountId}/pickup`, {
            method: 'POST'
          });

          const result = await response.json();
          if (result.ok) {
            this.activeMonitors.set(accountId, {
              accountId,
              email: accountEmail,
              sessionId: result.sessionId,
              startTime: Date.now(),
              type: 'pickup'
            });

            this.updateMonitorPanel();
            this.highlightAccountRow(accountId);

            showNotification(`å¼€å§‹ç›‘æ§ ${accountEmail}`, 'info');
          }
        } catch (error) {
          console.error('[Monitor] å¯åŠ¨ç›‘æ§å¤±è´¥:', error);
          showNotification('å¯åŠ¨ç›‘æ§å¤±è´¥', 'error');
        }
      }

      async startEmailMonitor(email) {
        try {
          const response = await fetch('/api/start-email-monitor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          const result = await response.json();
          if (result.ok) {
            showNotification(`å¼€å§‹ç›‘æ§ ${email}`, 'info');
          }
        } catch (error) {
          console.error('[Monitor] å¯åŠ¨é‚®ç®±ç›‘æ§å¤±è´¥:', error);
          showNotification('å¯åŠ¨ç›‘æ§å¤±è´¥', 'error');
        }
      }

      updateMonitorPanel() {
        const activeCount = this.activeMonitors.size;
        document.getElementById('activeMonitors').textContent = activeCount;

        const statusElement = document.getElementById('systemStatus');
        if (activeCount === 0) {
          statusElement.textContent = 'ç³»ç»Ÿç©ºé—²';
          statusElement.className = 'status-indicator idle';
        } else {
          statusElement.textContent = `ç›‘æ§ä¸­ (${activeCount})`;
          statusElement.className = 'status-indicator monitoring';
        }
      }

      highlightAccountRow(accountId) {
        const row = document.querySelector(`[data-account-id="${accountId}"]`);
        if (row) {
          row.classList.add('monitoring-active');
        }
      }

      stopMonitor(accountId) {
        this.activeMonitors.delete(accountId);

        const row = document.querySelector(`[data-account-id="${accountId}"]`);
        if (row) {
          row.classList.remove('monitoring-active');
        }

        this.updateMonitorPanel();
      }
    }

    // å…¨å±€å˜é‡
    let virtualScroll;
    let dataManager;
    let monitorClient;
    let currentFilters = {};

    // åˆå§‹åŒ–
    async function init() {
      virtualScroll = new VirtualScroll({
        container: document.getElementById('virtualScrollContainer'),
        content: document.getElementById('virtualScrollContent'),
        spacer: document.getElementById('scrollSpacer'),
        items: document.getElementById('scrollItems'),
        itemHeight: 60,
        bufferSize: 10
      });

      dataManager = new DataManager();
      monitorClient = new OnDemandMonitorClient();

      // åŠ è½½åˆå§‹æ•°æ®
      await loadInitialData();

      // è®¾ç½®äº‹ä»¶ç›‘å¬
      setupEventListeners();

      console.log('[App] é«˜æ€§èƒ½ç•Œé¢åˆå§‹åŒ–å®Œæˆ');
    }

    // åŠ è½½åˆå§‹æ•°æ®
    async function loadInitialData() {
      try {
        const data = await dataManager.loadAccounts(1, currentFilters);
        virtualScroll.setData(data.accounts || []);
      } catch (error) {
        console.error('[App] åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:', error);
        showNotification('åŠ è½½æ•°æ®å¤±è´¥', 'error');
      }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // æœç´¢è¾“å…¥
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentFilters.email = e.target.value;
          applyFilters();
        }, 300);
      });

      // çŠ¶æ€è¿‡æ»¤
      document.getElementById('statusFilter').addEventListener('change', (e) => {
        currentFilters.status = e.target.value;
        applyFilters();
      });

      // æ’åº
      document.getElementById('sortBy').addEventListener('change', (e) => {
        currentFilters.sortBy = e.target.value;
        applyFilters();
      });

      document.getElementById('sortOrder').addEventListener('change', (e) => {
        currentFilters.sortOrder = e.target.value;
        applyFilters();
      });

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case 'f':
              e.preventDefault();
              document.getElementById('searchInput').focus();
              break;
            case 'a':
              e.preventDefault();
              selectAll();
              break;
          }
        }
      });
    }

    // åº”ç”¨è¿‡æ»¤
    async function applyFilters() {
      if (!virtualScroll) return;

      // å¦‚æœæœ‰å¤§é‡æ•°æ®ï¼Œä»æœåŠ¡å™¨è·å–è¿‡æ»¤åçš„ç»“æœ
      if (virtualScroll.allItems.length > 1000) {
        try {
          const data = await dataManager.loadAccounts(1, currentFilters);
          virtualScroll.setData(data.accounts || []);
        } catch (error) {
          console.error('[App] åº”ç”¨è¿‡æ»¤å¤±è´¥:', error);
        }
      } else {
        // æœ¬åœ°è¿‡æ»¤
        virtualScroll.filterData(currentFilters);
      }
    }

    // æ”¹å˜æ’åº
    function changeSort(field) {
      const currentSort = currentFilters.sortBy;
      const currentOrder = currentFilters.sortOrder;

      currentFilters.sortBy = field;
      currentFilters.sortOrder = (currentSort === field && currentOrder === 'desc') ? 'asc' : 'desc';

      // æ›´æ–°UI
      document.getElementById('sortBy').value = field;
      document.getElementById('sortOrder').value = currentFilters.sortOrder;

      applyFilters();
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // å¤åˆ¶æ–‡æœ¬
    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

        // å¦‚æœå¤åˆ¶çš„æ˜¯é‚®ç®±ï¼Œå¯åŠ¨ç›‘æ§
        if (text && text.includes('@')) {
          monitorClient.startEmailMonitor(text);
        }
      }).catch(() => {
        showNotification('å¤åˆ¶å¤±è´¥', 'error');
      });
    }

    // å–ä»¶æŒ‰é’®
    async function pickup(accountId, btn) {
      btn.disabled = true;
      btn.textContent = 'å–ä»¶ä¸­...';

      try {
        const accountRow = document.querySelector(`[data-account-id="${accountId}"]`);
        const accountEmail = accountRow ? accountRow.dataset.email : 'æœªçŸ¥é‚®ç®±';

        await monitorClient.startAccountMonitor(accountId, accountEmail);

        // ç«‹å³æ£€æŸ¥ä¸€æ¬¡é‚®ä»¶
        const response = await fetch(`/accounts/${accountId}/check-now`, {
          method: 'POST'
        });

        const result = await response.json();
        if (result.ok && result.code) {
          showNotification(`å‘ç°éªŒè¯ç : ${result.code}`, 'success');
          setTimeout(() => {
            virtualScroll.refresh();
          }, 1500);
        }

      } catch (error) {
        console.error('[Pickup] å–ä»¶å¤±è´¥:', error);
        showNotification('å–ä»¶å¤±è´¥', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'å–ä»¶';
      }
    }

    // å…¨é€‰åŠŸèƒ½
    function selectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.rowchk');
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
    }

    function toggleAll(checkbox) {
      const checkboxes = document.querySelectorAll('.rowchk');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    // æ‰¹é‡å¤åˆ¶
    function bulkCopy(field) {
      const selected = document.querySelectorAll('.rowchk:checked');
      const values = Array.from(selected).map(cb => cb.dataset[field]).filter(Boolean);

      if (values.length === 0) {
        showNotification('è¯·é€‰æ‹©è¦å¤åˆ¶çš„å†…å®¹', 'error');
        return;
      }

      copyText(values.join('\n'));
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const visibleItems = virtualScroll.getVisibleItems();
      const csvContent = convertToCSV(visibleItems);
      downloadCSV(csvContent, 'accounts_export.csv');
      showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
    }

    function convertToCSV(items) {
      const headers = ['é‚®ç®±', 'çŠ¶æ€', 'æœ€åæ´»è·ƒæ—¶é—´', 'éªŒè¯ç ', 'éªŒè¯ç æ—¶é—´'];
      const rows = items.map(item => [
        item.email,
        item.status === 'authorized' ? 'å·²æˆæƒ' : 'å¾…æˆæƒ',
        item.last_active_at ? new Date(item.last_active_at).toLocaleString() : '',
        item.latestCode ? item.latestCode.code : '',
        item.latestCode ? new Date(item.latestCode.received_at).toLocaleString() : ''
      ]);

      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // åˆ‡æ¢æ€§èƒ½æŒ‡æ ‡æ˜¾ç¤º
    function togglePerformanceMetrics() {
      const metrics = document.getElementById('performanceMetrics');
      metrics.style.display = metrics.style.display === 'none' ? 'block' : 'none';
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (virtualScroll) {
        virtualScroll.destroy();
      }
    });
  </script>
</body>
</html>