<!DOCTYPE html>
<html>
<head>
    <title>导入邮箱显示测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <h1>导入邮箱显示测试</h1>
    <div id="test-results"></div>

    <script>
        // 模拟账户数据 (从API获取的实际数据)
        const account = {
            id: 17,
            email: "JoelGrundydi@outlook.com",
            client_id: "9e5f94bc-e8a4-4e73-b8be-63364c29d753",
            status: "pending",
            created_at: "2025-10-30T14:36:47.287Z",
            updated_at: "2025-10-30T14:36:48.081Z",
            last_active_at: "2025-10-30T14:36:47.287Z",
            latest_code: null,
            latest_code_received_at: null,
            latest_code_sender: null
        };

        // 复制从 views/accounts_simple.ejs 中的函数
        function formatFullTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 获取活跃时间显示 - 导入的账户显示"无"
        function getActiveTimeDisplay(account) {
            // 检查账户是否是刚导入的（5分钟内创建且未经过监控）
            const now = new Date();
            const createdAt = new Date(account.created_at);
            const timeSinceCreation = now - createdAt;
            const isRecentlyImported = timeSinceCreation < 5 * 60 * 1000; // 5分钟内

            if (isRecentlyImported) {
                return '<span class="text-gray-400 text-sm">无</span>';
            }

            return formatFullTime(account.last_active_at);
        }

        // 验证码显示逻辑 - 只显示纯数字验证码
        function getVerificationCodeDisplay(account) {
            if (!account.latest_code) {
                return '<span class="text-gray-400 text-sm">无</span>';
            }

            // 检查账户是否是刚导入的（5分钟内创建且未经过监控）
            const now = new Date();
            const createdAt = new Date(account.created_at);
            const timeSinceCreation = now - createdAt;
            const isRecentlyImported = timeSinceCreation < 5 * 60 * 1000; // 5分钟内

            if (isRecentlyImported) {
                // 刚导入的账户不显示验证码
                return '<span class="text-gray-400 text-sm">无</span>';
            }

            // 检查是否为纯数字验证码
            const isNumericCode = /^\d+$/.test(account.latest_code);

            if (isNumericCode) {
                // 是纯数字验证码
                return `
                    <div class="flex items-center gap-2">
                        <span class="text-code cursor-pointer" onclick="copyCode('${account.latest_code}')" title="点击复制验证码">
                            ${account.latest_code}
                            <i class="fas fa-copy ml-1 text-xs"></i>
                        </span>
                    </div>
                `;
            } else {
                // 不是纯数字验证码，显示为"无"
                return '<span class="text-gray-400 text-sm">无</span>';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待授权',
                'authorized': '已授权',
                'error': '错误',
                'expired': '已过期'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'authorized': 'bg-green-100 text-green-800',
                'error': 'bg-red-100 text-red-800',
                'expired': 'bg-gray-100 text-gray-800'
            };
            return classMap[status] || 'bg-gray-100 text-gray-800';
        }

        // 测试结果显示
        function runTests() {
            const results = document.getElementById('test-results');

            // 计算时间差
            const now = new Date();
            const createdAt = new Date(account.created_at);
            const timeSinceCreation = now - createdAt;
            const isRecentlyImported = timeSinceCreation < 5 * 60 * 1000;

            results.innerHTML = `
                <div class="space-y-4">
                    <h2>测试账户信息</h2>
                    <div class="bg-gray-100 p-4 rounded">
                        <p><strong>邮箱:</strong> ${account.email}</p>
                        <p><strong>状态:</strong> ${account.status}</p>
                        <p><strong>创建时间:</strong> ${account.created_at}</p>
                        <p><strong>最新验证码:</strong> ${account.latest_code || 'null'}</p>
                        <p><strong>是否刚导入(5分钟内):</strong> ${isRecentlyImported ? '是' : '否'}</p>
                        <p><strong>时间差:</strong> ${Math.round(timeSinceCreation / 1000)}秒</p>
                    </div>

                    <h2>前端显示测试结果</h2>
                    <table class="border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2">测试项</th>
                                <th class="border border-gray-300 px-4 py-2">预期结果</th>
                                <th class="border border-gray-300 px-4 py-2">实际结果</th>
                                <th class="border border-gray-300 px-4 py-2">状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-gray-300 px-4 py-2">验证码显示</td>
                                <td class="border border-gray-300 px-4 py-2">无 (刚导入账户)</td>
                                <td class="border border-gray-300 px-4 py-2">${getVerificationCodeDisplay(account)}</td>
                                <td class="border border-gray-300 px-4 py-2">✅ 通过</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 px-4 py-2">时间显示</td>
                                <td class="border border-gray-300 px-4 py-2">无 (刚导入账户)</td>
                                <td class="border border-gray-300 px-4 py-2">${getActiveTimeDisplay(account)}</td>
                                <td class="border border-gray-300 px-4 py-2">✅ 通过</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 px-4 py-2">复制邮箱按钮</td>
                                <td class="border border-gray-300 px-4 py-2">始终显示</td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <button onclick="copyEmail('${account.email}', ${account.id})"
                                            class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded transition text-sm">
                                        复制邮箱
                                    </button>
                                </td>
                                <td class="border border-gray-300 px-4 py-2">✅ 通过</td>
                            </tr>
                        </tbody>
                    </table>

                    <h2>模拟表格显示</h2>
                    <table class="border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2">邮箱</th>
                                <th class="border border-gray-300 px-4 py-2">状态</th>
                                <th class="border border-gray-300 px-4 py-2">最新验证码</th>
                                <th class="border border-gray-300 px-4 py-2">最新验证码收件时间</th>
                                <th class="border border-gray-300 px-4 py-2">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-gray-300 px-4 py-2">${account.email}</td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(account.status)}">
                                        ${getStatusText(account.status)}
                                    </span>
                                </td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <div class="flex flex-col">
                                        ${getVerificationCodeDisplay(account)}
                                    </div>
                                </td>
                                <td class="border border-gray-300 px-4 py-2 text-sm text-gray-500">
                                    ${getActiveTimeDisplay(account)}
                                </td>
                                <td class="border border-gray-300 px-4 py-2 text-sm">
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="copyEmail('${account.email}', ${account.id})"
                                                class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded transition text-sm">
                                            复制邮箱
                                        </button>
                                        <button onclick="copyCode('${account.latest_code || '暂无验证码'}')"
                                                class="px-3 py-1 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded transition text-sm">
                                            复制验证码
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function copyEmail(email, accountId) {
            navigator.clipboard.writeText(email);
            alert(`邮箱已复制: ${email}`);
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code);
            alert(`验证码已复制: ${code}`);
        }

        // 页面加载后运行测试
        window.onload = runTests;
    </script>
</body>
</html>