<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件管理代理服务器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-server text-blue-600 mr-2"></i>
                邮件管理代理服务器
            </h1>
            <p class="text-gray-600">CORS代理服务器 - 解决跨域访问Outlook API</p>
        </header>

        <!-- 服务状态 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-heartbeat text-green-500 mr-2"></i>
                服务状态
            </h2>
            <div id="serviceStatus" class="text-gray-600">
                正在检查服务状态...
            </div>
        </div>

        <!-- API端点 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-plug text-blue-500 mr-2"></i>
                API端点
            </h2>
            <div class="space-y-3">
                <div class="border-l-4 border-blue-500 pl-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">GET /api/health</code>
                    <p class="text-sm text-gray-600 mt-1">健康检查端点</p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">POST /api/microsoft/token</code>
                    <p class="text-sm text-gray-600 mt-1">Microsoft OAuth token端点</p>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">GET /api/outlook/*</code>
                    <p class="text-sm text-gray-600 mt-1">Outlook REST API代理端点</p>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">GET /api/events/stream</code>
                    <p class="text-sm text-gray-600 mt-1">SSE实时事件流端点</p>
                </div>
            </div>
        </div>

        <!-- 测试面板 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-flask text-purple-500 mr-2"></i>
                API测试
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="testHealth()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                    <i class="fas fa-heartbeat mr-2"></i>测试健康检查
                </button>
                <button onclick="testSSE()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-stream mr-2"></i>测试SSE流
                </button>
            </div>
            <div id="testResults" class="mt-4 hidden">
                <h3 class="font-semibold mb-2">测试结果:</h3>
                <pre id="testOutput" class="bg-gray-100 p-3 rounded text-sm overflow-auto max-h-64"></pre>
            </div>
        </div>

        <!-- 实时事件 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                实时事件
            </h2>
            <div id="eventLog" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-auto">
                <div class="text-gray-500">等待事件...</div>
            </div>
        </div>

        <!-- 链接到主应用 -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-envelope text-indigo-500 mr-2"></i>
                邮件管理应用
            </h2>
            <p class="text-gray-600 mb-4">访问邮件管理主应用：</p>
            <a href="simple-mail-manager.html" class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                <i class="fas fa-external-link-alt mr-2"></i>
                打开邮件管理系统
            </a>
        </div>
    </div>

    <script>
        let eventSource = null;
        let eventCount = 0;

        // 检查服务状态
        async function checkServiceStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                document.getElementById('serviceStatus').innerHTML = `
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>服务运行正常</span>
                        <span class="ml-2 text-sm text-gray-500">版本: ${data.version}</span>
                    </div>
                    <div class="text-sm text-gray-500 mt-1">
                        时间: ${new Date(data.timestamp).toLocaleString()}
                    </div>
                `;
            } catch (error) {
                document.getElementById('serviceStatus').innerHTML = `
                    <div class="flex items-center text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>服务连接失败</span>
                    </div>
                    <div class="text-sm text-gray-500 mt-1">
                        错误: ${error.message}
                    </div>
                `;
            }
        }

        // 测试健康检查
        async function testHealth() {
            showTestResults();
            updateTestOutput('正在测试健康检查端点...');

            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                updateTestOutput('✅ 健康检查成功:\n' + JSON.stringify(data, null, 2));
            } catch (error) {
                updateTestOutput('❌ 健康检查失败:\n' + error.message);
            }
        }

        // 测试SSE流
        function testSSE() {
            showTestResults();
            updateTestOutput('正在连接SSE事件流...');

            try {
                eventSource = new EventSource('/api/events/stream');

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateTestOutput('✅ SSE事件接收:\n' + JSON.stringify(data, null, 2));
                    eventSource.close();
                };

                eventSource.onerror = function(error) {
                    updateTestOutput('❌ SSE连接失败:\n' + error);
                };

                // 5秒后超时
                setTimeout(() => {
                    if (eventSource) {
                        eventSource.close();
                        updateTestOutput('⏰ SSE连接超时');
                    }
                }, 5000);

            } catch (error) {
                updateTestOutput('❌ SSE创建失败:\n' + error.message);
            }
        }

        // 显示测试结果区域
        function showTestResults() {
            document.getElementById('testResults').classList.remove('hidden');
        }

        // 更新测试输出
        function updateTestOutput(text) {
            document.getElementById('testOutput').textContent = text;
        }

        // 连接SSE事件流
        function connectSSE() {
            try {
                eventSource = new EventSource('/api/events/stream');

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    eventCount++;
                    addEventLog(`[${new Date().toLocaleTimeString()}] ${data.type}: ${data.message}`);
                };

                eventSource.onerror = function(error) {
                    addEventLog(`[${new Date().toLocaleTimeString()}] 连接错误: ${error}`);
                    // 5秒后重连
                    setTimeout(connectSSE, 5000);
                };

            } catch (error) {
                addEventLog(`[${new Date().toLocaleTimeString()}] 连接失败: ${error.message}`);
            }
        }

        // 添加事件日志
        function addEventLog(message) {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);

            // 保持最多50条日志
            const entries = logDiv.children;
            if (entries.length > 50) {
                logDiv.removeChild(entries[0]);
            }

            // 自动滚动到底部
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkServiceStatus();
            connectSSE();

            // 每30秒检查一次服务状态
            setInterval(checkServiceStatus, 30000);
        });

        // 页面卸载时关闭SSE连接
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>