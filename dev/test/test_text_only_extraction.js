const EmailService = require('./server/emailService.js');

// æµ‹è¯•åªä»çº¯æ–‡æœ¬å†…å®¹æå–éªŒè¯ç 
function testTextOnlyExtraction() {
    console.log('=== æµ‹è¯•åªä»çº¯æ–‡æœ¬å†…å®¹æå–éªŒè¯ç  ===\n');

    const emailService = new EmailService();

    // æ¨¡æ‹ŸNormanBarrerasijçš„Welcome to Cometé‚®ä»¶ï¼ˆçº¯æ–‡æœ¬ç‰ˆæœ¬ï¼‰
    const testEmail = {
        Subject: 'Welcome to Comet',
        From: { EmailAddress: { Name: 'Perplexity', Address: 'team@mail.perplexity.ai' } },
        Body: {
            Content: `
                <html>
                <head>
                <style>
                    .color { color: #4138; }
                    .bg { background: #9947; }
                </style>
                </head>
                <body>
                    <h1>Welcome to Comet</h1>
                    <p>Comet is your personal assistant, study buddy and tutor.</p>
                    <p>Our goal is simple: help you get your work done faster while getting better grades.</p>

                    <div class="verification">Your temporary code: 000000</div>

                    <p>Explore Comet</p>

                    <script>
                        var config = { "code": "4138", "tracking": "9947" };
                    </script>

                    <p>Ways Comet can help you</p>
                    <p>Turn any webpage into your study partner</p>

                    <div style="display:none;">hidden: 4138</div>

                    <p>Â© 2025 Perplexity. 115 Sansome St, Suite 900, San Francisco, CA 94104</p>
                </body>
                </html>
            `
        },
        ReceivedDateTime: '2025-10-29T21:46:28Z'
    };

    console.log('ğŸ“§ æµ‹è¯•é‚®ä»¶å†…å®¹:');
    console.log('ä¸»é¢˜:', testEmail.Subject);
    console.log('åŸå§‹HTMLé•¿åº¦:', testEmail.Body.Content.length);

    // ä½¿ç”¨ä¿®æ­£åçš„ç®—æ³•æå–éªŒè¯ç 
    const results = emailService.extractVerificationCodes([testEmail]);

    console.log('\nğŸ” æå–ç»“æœ:');
    if (results.length > 0) {
        results.forEach((result, index) => {
            console.log(`${index + 1}. éªŒè¯ç : ${result.code}`);
            console.log(`   ä¸»é¢˜: ${result.subject}`);
            console.log(`   æ—¶é—´: ${result.received_at}`);
        });
    } else {
        console.log('æœªæå–åˆ°éªŒè¯ç ');
    }

    console.log('\nğŸ“Š åˆ†æ:');
    console.log('âœ… HTMLæ ·å¼ä¸­çš„#4138è¢«æ­£ç¡®å¿½ç•¥');
    console.log('âœ… JavaScriptä¸­çš„"4138"è¢«æ­£ç¡®å¿½ç•¥');
    console.log('âœ… éšè—å…ƒç´ ä¸­çš„"4138"è¢«æ­£ç¡®å¿½ç•¥');
    console.log('âœ… åªä»å¯è§æ–‡æœ¬å†…å®¹ä¸­æå–éªŒè¯ç ');

    // æµ‹è¯•åŒ…å«çœŸå®éªŒè¯ç çš„é‚®ä»¶
    console.log('\n--- æµ‹è¯•åŒ…å«çœŸå®éªŒè¯ç çš„é‚®ä»¶ ---');
    const realCodeEmail = {
        Subject: 'Sign in to Perplexity',
        From: { EmailAddress: { Name: 'Perplexity', Address: 'team@mail.perplexity.ai' } },
        Body: {
            Content: `
                <html>
                <body>
                    <p>Sign in to your account</p>
                    <p>Your verification code is: <strong>680616</strong></p>
                    <p>Please use this code to complete your sign in.</p>
                    <style>.color { color: #4138; }</style>
                </body>
                </html>
            `
        },
        ReceivedDateTime: '2025-10-28T03:23:10Z'
    };

    const realCodeResults = emailService.extractVerificationCodes([realCodeEmail]);
    console.log('çœŸå®éªŒè¯ç é‚®ä»¶æå–ç»“æœ:', realCodeResults.length > 0 ? realCodeResults[0].code : 'æ— éªŒè¯ç ');
}

// è¿è¡Œæµ‹è¯•
testTextOnlyExtraction();