<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件验证码管理系统 - 浏览器版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 14px;
        }

        .stat-number {
            font-weight: bold;
            color: #007bff;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .table-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .table-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
            max-width: 100%;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }

        .sort-icon {
            margin-left: 8px;
            opacity: 0.5;
        }

        .sort-icon.active {
            opacity: 1;
            color: #007bff;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .checkbox-cell {
            width: 50px;
        }

        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
        }

        .custom-checkbox input {
            opacity: 0;
            position: absolute;
            cursor: pointer;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 2px solid #ccc;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: #007bff;
            border-color: #007bff;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-authorized {
            background: #d4edda;
            color: #155724;
        }

        .status-authorized .status-dot {
            background: #28a745;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-pending .status-dot {
            background: #ffc107;
        }

        .status-reauth_needed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-reauth_needed .status-dot {
            background: #dc3545;
        }

        .email-cell {
            max-width: 250px;
        }

        .email-primary {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .email-secondary {
            font-size: 12px;
            color: #6c757d;
        }

        .code-display {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #007bff;
            letter-spacing: 1px;
        }

        .code-display.empty {
            color: #6c757d;
            background: #f8f9fa;
            border-color: #dee2e6;
            font-style: italic;
        }

        .time-display {
            font-size: 13px;
            color: #6c757d;
        }

        .actions {
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        tbody tr:hover .actions {
            opacity: 1;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .pagination {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #dee2e6;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #000;
            background: #f8f9fa;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-help {
            margin-top: 6px;
            font-size: 12px;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .storage-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
        }

        .storage-icon {
            font-size: 20px;
        }

        .storage-info {
            font-size: 12px;
            color: #6c757d;
        }

        .storage-bar {
            width: 120px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #007bff);
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #007bff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #212529; }
        .toast.info { background: #17a2b8; }

        .bulk-import-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .bulk-import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bulk-import-steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .step-item {
            display: flex;
            align-items: start;
            gap: 15px;
            margin-bottom: 15px;
        }

        .step-item:last-child {
            margin-bottom: 0;
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }

        .step-description {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-buttons {
                flex-direction: column;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }

            .storage-indicator {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }

            .actions {
                opacity: 1;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px;
            }

            .email-cell {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>📧</span>
                <span>邮件验证码管理系统 - 浏览器版</span>
            </h1>

            <div class="header-stats">
                <div class="stat-item">
                    <span>总账户:</span>
                    <span class="stat-number" id="totalAccounts">0</span>
                </div>
                <div class="stat-item">
                    <span>已授权:</span>
                    <span class="stat-number" id="authorizedAccounts">0</span>
                </div>
                <div class="stat-item">
                    <span>待授权:</span>
                    <span class="stat-number" id="pendingAccounts">0</span>
                </div>
                <div class="stat-item">
                    <span>需重新授权:</span>
                    <span class="stat-number" id="reauthAccounts">0</span>
                </div>
                <div class="stat-item">
                    <span>验证码:</span>
                    <span class="stat-number" id="totalCodes">0</span>
                </div>
            </div>

            <div class="header-buttons">
                <button class="btn-primary" onclick="openAddAccountModal()">
                    <span>➕</span>
                    <span>添加账户</span>
                </button>
                <button class="btn-success" onclick="openBulkImportModal()">
                    <span>📥</span>
                    <span>批量导入</span>
                </button>
                <button class="btn-secondary" onclick="exportData()">
                    <span>📤</span>
                    <span>导出数据</span>
                </button>
                <button class="btn-warning" onclick="bulkSync()">
                    <span>🔄</span>
                    <span>批量同步</span>
                </button>
                <button class="btn-secondary" onclick="refreshData()">
                    <span>🔃</span>
                    <span>刷新</span>
                </button>
            </div>
        </header>

        <div class="bulk-import-section" id="bulkImportSection" style="display: none;">
            <div class="bulk-import-header">
                <h3>批量导入邮箱账户</h3>
                <button class="btn-secondary" onclick="closeBulkImport()">✕</button>
            </div>

            <div class="bulk-import-steps">
                <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">准备账户数据</div>
                        <div class="step-description">
                            创建CSV文件，格式：<br>
                            <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">邮箱地址,Client ID,Refresh Token</code><br>
                            每行一个账户，支持Excel或文本编辑器编辑
                        </div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">上传文件</div>
                        <div class="step-description">
                            选择准备好的CSV文件，系统将自动解析并显示预览
                        </div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">确认导入</div>
                        <div class="step-description">
                            确认账户数据无误后，系统将自动开始导入和验证流程
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; align-items: center;">
                <input type="file" id="bulkImportFile" accept=".txt,.csv" style="display: none;">
                <button class="btn-primary" onclick="document.getElementById('bulkImportFile').click()">
                    <span>📁</span>
                    <span>选择文件</span>
                </button>
                <span id="selectedFileName" style="color: #6c757d;">未选择文件</span>
                <button class="btn-success" id="startBulkImport" onclick="startBulkImport()" disabled>
                    <span>🚀</span>
                    <span>开始导入</span>
                </button>
            </div>

            <div id="bulkImportPreview" style="margin-top: 20px; display: none;">
                <h4>预览 (前10个邮箱):</h4>
                <div id="previewList" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;"></div>
            </div>

            <div id="bulkImportProgress" style="display: none; margin-top: 20px;">
                <h4>导入进度:</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="importProgressFill"></div>
                </div>
                <div id="importStatusText">准备中...</div>
            </div>
        </div>

        <div class="main-content">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">账户列表</h2>
                    <div class="table-controls">
                        <input type="text" class="search-input" placeholder="🔍 搜索邮箱地址..." oninput="searchAccounts(this.value)">
                        <select class="filter-select" onchange="filterByStatus(this.value)">
                            <option value="">所有状态</option>
                            <option value="authorized">已授权</option>
                            <option value="pending">待授权</option>
                            <option value="reauth_needed">需重新授权</option>
                        </select>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        <span class="checkmark"></span>
                                    </label>
                                </th>
                                <th onclick="sortTable('status')">
                                    状态
                                    <span class="sort-icon" id="sort-status">↕</span>
                                </th>
                                <th onclick="sortTable('email')">
                                    邮箱地址
                                    <span class="sort-icon" id="sort-email">↕</span>
                                </th>
                                <th onclick="sortTable('code')">
                                    最新验证码
                                    <span class="sort-icon" id="sort-code">↕</span>
                                </th>
                                <th onclick="sortTable('received_time')">
                                    收件时间
                                    <span class="sort-icon" id="sort-received_time">↕</span>
                                </th>
                                <th onclick="sortTable('updated_time')">
                                    更新时间
                                    <span class="sort-icon" id="sort-updated_time">↕</span>
                                </th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <div class="pagination-info">
                        <span id="paginationInfo">显示 0 个账户</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn-secondary btn-sm" id="prevPage" onclick="changePage(-1)" disabled>
                            上一页
                        </button>
                        <span id="pageInfo">第 1 页，共 1 页</span>
                        <button class="btn-secondary btn-sm" id="nextPage" onclick="changePage(1)" disabled>
                            下一页
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加账户模态框 -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">添加邮箱账户</h2>
                <button class="modal-close" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm" onsubmit="addAccount(event)">
                    <div class="form-group">
                        <label class="form-label">邮箱地址 *</label>
                        <input type="email" class="form-input" id="newAccountEmail" required placeholder="example@outlook.com">
                        <div class="form-help">请输入完整的邮箱地址</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">显示名称</label>
                        <input type="text" class="form-input" id="newAccountName" placeholder="可选，用于识别账户">
                        <div class="form-help">为账户设置友好的显示名称</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client ID *</label>
                        <input type="text" class="form-input" id="newAccountClientId" required placeholder="Azure应用客户端ID">
                        <div class="form-help">从Azure应用注册获取的客户端ID</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Refresh Token *</label>
                        <textarea class="form-input" id="newAccountRefreshToken" required placeholder="Microsoft账户的刷新令牌" rows="3"></textarea>
                        <div class="form-help">用于自动获取访问令牌的刷新令牌</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addAccountModal')">取消</button>
                <button class="btn-primary" onclick="document.getElementById('addAccountForm').requestSubmit()">
                    <span>➕</span>
                    <span>添加账户</span>
                </button>
            </div>
        </div>
    </div>

  
    <!-- 存储指示器 -->
    <div class="storage-indicator">
        <span class="storage-icon">💾</span>
        <div>
            <div class="storage-info">本地存储</div>
            <div class="storage-bar">
                <div class="storage-fill" id="storageFill"></div>
            </div>
        </div>
        <div class="storage-info" id="storageText">0 KB</div>
    </div>

    <script>
        // 完整功能的邮件管理系统 - 浏览器版本
        class BrowserMailManager {
            constructor() {
                this.accounts = [];
                this.filteredAccounts = [];
                this.selectedAccounts = new Set();
                this.currentPage = 1;
                this.itemsPerPage = 20;
                this.sortField = 'updated_time';
                this.sortDirection = 'desc';
                this.searchQuery = '';
                this.statusFilter = '';

                // 代理服务器配置
                this.proxyConfig = {
                    baseUrl: window.location.protocol === 'file:' ?
                        'http://localhost:3001' :
                        window.location.origin.replace(':8000', ':3001'),
                    tokenEndpoint: '/api/microsoft/token',
                    outlookEndpoint: '/api/outlook'
                };

                // 检测代理服务器可用性
                this.checkProxyServer();

                this.init();
            }

            async init() {
                await this.loadAccounts();
                this.setupEventListeners();
                this.render();
                this.updateStats();
                this.updateStorageIndicator();
                this.startPeriodicSync();

                // 检查代理服务器
                await this.checkProxyServer();

                console.log('邮件管理系统初始化完成');
            }

            // 检查代理服务器
            async checkProxyServer() {
                try {
                    const response = await fetch(`${this.proxyConfig.baseUrl}/api/health`);
                    if (response.ok) {
                        console.log('✅ 代理服务器连接正常');
                        this.proxyAvailable = true;
                    } else {
                        throw new Error('代理服务器响应异常');
                    }
                } catch (error) {
                    console.warn('⚠️ 代理服务器不可用，将尝试直接访问API:', error.message);
                    this.proxyAvailable = false;
                }
            }

            setupEventListeners() {
                // 文件上传监听
                document.getElementById('bulkImportFile').addEventListener('change', (e) => {
                    this.handleBulkImportFile(e);
                });

                // 点击模态框外部关闭
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.style.display = 'none';
                        });
                    }
                    if (e.ctrlKey && e.key === 'n') {
                        e.preventDefault();
                        openAddAccountModal();
                    }
                });
            }

            // 数据存储 - 使用IndexedDB以支持大量数据
            async saveAccounts() {
                try {
                    const data = {
                        accounts: this.accounts,
                        version: '2.0',
                        lastUpdated: new Date().toISOString()
                    };

                    // 使用IndexedDB存储大量数据
                    if ('indexedDB' in window) {
                        await this.saveToIndexedDB(data);
                    } else {
                        // 降级到LocalStorage
                        localStorage.setItem('mailmanager_data', JSON.stringify(data));
                    }
                } catch (error) {
                    console.error('保存数据失败:', error);
                    this.showToast('数据保存失败', 'error');
                }
            }

            async loadAccounts() {
                try {
                    let data;

                    if ('indexedDB' in window) {
                        data = await this.loadFromIndexedDB();
                    } else {
                        // 降级到LocalStorage
                        const stored = localStorage.getItem('mailmanager_data');
                        data = stored ? JSON.parse(stored) : null;
                    }

                    this.accounts = data?.accounts || [];
                    this.filteredAccounts = [...this.accounts];
                } catch (error) {
                    console.error('加载数据失败:', error);
                    this.accounts = [];
                    this.filteredAccounts = [];
                }
            }

            async saveToIndexedDB(data) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('MailManagerDB', 1);

                    request.onerror = () => reject(request.error);

                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['accounts'], 'readwrite');
                        const store = transaction.objectStore('accounts');

                        const putRequest = store.put(data, 'main_data');
                        putRequest.onsuccess = () => resolve();
                        putRequest.onerror = () => reject(putRequest.error);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('accounts')) {
                            db.createObjectStore('accounts');
                        }
                    };
                });
            }

            async loadFromIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('MailManagerDB', 1);

                    request.onerror = () => reject(request.error);

                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['accounts'], 'readonly');
                        const store = transaction.objectStore('accounts');

                        const getRequest = store.get('main_data');
                        getRequest.onsuccess = () => resolve(getRequest.result);
                        getRequest.onerror = () => reject(getRequest.error);
                    };

                    request.onupgradeneeded = () => {
                        resolve(null);
                    };
                });
            }

            // 账户管理
            addAccount(email, name, clientId, refreshToken) {
                if (this.accounts.some(acc => acc.email === email)) {
                    throw new Error('该邮箱地址已存在');
                }

                const account = {
                    id: Date.now().toString(),
                    email: email,
                    name: name || email,
                    client_id: clientId,
                    refresh_token: refreshToken,
                    status: 'pending',
                    codes: [],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    access_token: null,
                    token_expires_at: null,
                    last_sync: null
                };

                this.accounts.push(account);
                this.saveAccounts();
                return account;
            }

            deleteAccount(id) {
                this.accounts = this.accounts.filter(acc => acc.id !== id);
                this.selectedAccounts.delete(id);
                this.saveAccounts();
            }

            updateAccountStatus(id, status, tokens = {}) {
                const account = this.accounts.find(acc => acc.id === id);
                if (account) {
                    account.status = status;
                    account.updated_at = new Date().toISOString();

                    if (tokens.access_token) {
                        account.access_token = tokens.access_token;
                        account.refresh_token = tokens.refresh_token;
                        account.token_expires_at = tokens.expires_at;
                    }

                    this.saveAccounts();
                }
            }

            addVerificationCode(accountId, code, sender, receivedAt) {
                const account = this.accounts.find(acc => acc.id === accountId);
                if (account) {
                    const newCode = {
                        code: code,
                        sender: sender || 'Unknown',
                        received_at: receivedAt || new Date().toISOString(),
                        extracted_at: new Date().toISOString()
                    };

                    account.codes.unshift(newCode);

                    // 只保留最新50个验证码
                    if (account.codes.length > 50) {
                        account.codes = account.codes.slice(0, 50);
                    }

                    account.updated_at = new Date().toISOString();
                    this.saveAccounts();
                }
            }

            // 搜索和过滤
            searchAccounts(query) {
                this.searchQuery = query.toLowerCase();
                this.applyFilters();
            }

            filterByStatus(status) {
                this.statusFilter = status;
                this.applyFilters();
            }

            applyFilters() {
                this.filteredAccounts = this.accounts.filter(account => {
                    const matchesSearch = !this.searchQuery ||
                        account.email.toLowerCase().includes(this.searchQuery) ||
                        account.name.toLowerCase().includes(this.searchQuery);

                    const matchesStatus = !this.statusFilter || account.status === this.statusFilter;

                    return matchesSearch && matchesStatus;
                });

                this.currentPage = 1;
                this.render();
            }

            // 排序
            sortTable(field) {
                if (this.sortField === field) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortDirection = 'asc';
                }

                // 更新排序图标
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.classList.remove('active');
                    icon.textContent = '↕';
                });

                const currentIcon = document.getElementById(`sort-${field}`);
                currentIcon.classList.add('active');
                currentIcon.textContent = this.sortDirection === 'asc' ? '↑' : '↓';

                this.applyFilters();
            }

            sortAccounts(accounts) {
                return accounts.sort((a, b) => {
                    let aValue, bValue;

                    switch (this.sortField) {
                        case 'status':
                            aValue = a.status;
                            bValue = b.status;
                            break;
                        case 'email':
                            aValue = a.email.toLowerCase();
                            bValue = b.email.toLowerCase();
                            break;
                        case 'code':
                            aValue = a.codes[0]?.code || '';
                            bValue = b.codes[0]?.code || '';
                            break;
                        case 'received_time':
                            aValue = a.codes[0]?.received_at || '';
                            bValue = b.codes[0]?.received_at || '';
                            break;
                        case 'updated_time':
                            aValue = a.updated_at;
                            bValue = b.updated_at;
                            break;
                        default:
                            return 0;
                    }

                    if (!aValue && !bValue) return 0;
                    if (!aValue) return 1;
                    if (!bValue) return -1;

                    let comparison = 0;
                    if (aValue > bValue) comparison = 1;
                    if (aValue < bValue) comparison = -1;

                    return this.sortDirection === 'desc' ? -comparison : comparison;
                });
            }

            // 渲染
            render() {
                this.renderTable();
                this.updatePagination();
            }

            renderTable() {
                const tbody = document.getElementById('accountsTableBody');

                if (this.filteredAccounts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">📭</div>
                                <h3>暂无邮箱账户</h3>
                                <p>点击"添加账户"或"批量导入"开始使用</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // 排序
                const sortedAccounts = this.sortAccounts([...this.filteredAccounts]);

                // 分页
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageAccounts = sortedAccounts.slice(startIndex, endIndex);

                tbody.innerHTML = pageAccounts.map(account => {
                    const latestCode = account.codes[0];
                    const isSelected = this.selectedAccounts.has(account.id);

                    return `
                        <tr>
                            <td class="checkbox-cell">
                                <label class="custom-checkbox">
                                    <input type="checkbox"
                                           class="account-checkbox"
                                           data-account-id="${account.id}"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleAccountSelection('${account.id}', this.checked)">
                                    <span class="checkmark"></span>
                                </label>
                            </td>
                            <td>
                                <span class="status-badge status-${account.status}">
                                    <span class="status-dot"></span>
                                    ${this.getStatusText(account.status)}
                                </span>
                            </td>
                            <td class="email-cell">
                                <div class="email-primary">${account.name}</div>
                                <div class="email-secondary">${account.email}</div>
                            </td>
                            <td>
                                ${latestCode ?
                                    `<div class="code-display">${latestCode.code}</div>` :
                                    '<div class="code-display empty">暂无验证码</div>'
                                }
                            </td>
                            <td>
                                <div class="time-display">
                                    ${latestCode ? this.formatTime(latestCode.received_at) : '---'}
                                </div>
                            </td>
                            <td>
                                <div class="time-display">
                                    ${this.formatTime(account.updated_at)}
                                </div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn-sm btn-primary" onclick="syncAccount('${account.id}')" title="同步">
                                        🔄
                                    </button>
                                    <button class="btn-sm btn-warning" onclick="reauthAccount('${account.id}')" title="重新授权">
                                        🔐
                                    </button>
                                    <button class="btn-sm btn-danger" onclick="deleteAccount('${account.id}')" title="删除">
                                        🗑️
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updatePagination() {
                const totalItems = this.filteredAccounts.length;
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                const startItem = totalItems === 0 ? 0 : (this.currentPage - 1) * this.itemsPerPage + 1;
                const endItem = Math.min(this.currentPage * this.itemsPerPage, totalItems);

                document.getElementById('paginationInfo').textContent =
                    `显示 ${startItem}-${endItem} 个账户，共 ${totalItems} 个`;

                document.getElementById('pageInfo').textContent =
                    `第 ${this.currentPage} 页，共 ${totalPages || 1} 页`;

                document.getElementById('prevPage').disabled = this.currentPage === 1;
                document.getElementById('nextPage').disabled = this.currentPage === totalPages || totalPages === 0;
            }

            updateStats() {
                const stats = {
                    total: this.accounts.length,
                    authorized: this.accounts.filter(acc => acc.status === 'authorized').length,
                    pending: this.accounts.filter(acc => acc.status === 'pending').length,
                    reauth: this.accounts.filter(acc => acc.status === 'reauth_needed').length,
                    codes: this.accounts.reduce((sum, acc) => sum + acc.codes.length, 0)
                };

                document.getElementById('totalAccounts').textContent = stats.total;
                document.getElementById('authorizedAccounts').textContent = stats.authorized;
                document.getElementById('pendingAccounts').textContent = stats.pending;
                document.getElementById('reauthAccounts').textContent = stats.reauth;
                document.getElementById('totalCodes').textContent = stats.codes;
            }

            updateStorageIndicator() {
                try {
                    const data = JSON.stringify({ accounts: this.accounts });
                    const sizeInBytes = new Blob([data]).size;
                    const sizeInKB = (sizeInBytes / 1024).toFixed(1);

                    // 估算LocalStorage限制 (通常5-10MB)
                    const estimatedLimit = 5 * 1024; // 5MB
                    const percentage = Math.min((sizeInKB / estimatedLimit) * 100, 100);

                    document.getElementById('storageFill').style.width = `${percentage}%`;
                    document.getElementById('storageText').textContent = `${sizeInKB} KB`;

                    // 根据使用量改变颜色
                    const fillElement = document.getElementById('storageFill');
                    if (percentage > 80) {
                        fillElement.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
                    } else if (percentage > 60) {
                        fillElement.style.background = 'linear-gradient(90deg, #ffc107, #e0a800)';
                    } else {
                        fillElement.style.background = 'linear-gradient(90deg, #28a745, #007bff)';
                    }
                } catch (error) {
                    console.warn('更新存储指示器失败:', error);
                }
            }

            // 验证账户授权（直接使用refresh token）
            async validateAccountAuth(accountId) {
                const account = this.accounts.find(acc => acc.id === accountId);
                if (!account || !account.client_id || !account.refresh_token) {
                    this.showToast('账户缺少必要的授权信息', 'error');
                    return;
                }

                try {
                    this.showToast('正在验证账户授权...', 'info');

                    // 使用代理服务器调用Microsoft token刷新端点
                    const PROXY_URL = 'http://localhost:3001/api/microsoft/token';
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: account.client_id,
                            refresh_token: account.refresh_token,
                            grant_type: 'refresh_token',
                            scope: 'https://outlook.office.com/Mail.ReadWrite https://outlook.office.com/IMAP.AccessAsUser.All https://outlook.office.com/POP.AccessAsUser.All https://outlook.office.com/SMTP.Send'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const accessToken = data.access_token;
                        const expiresIn = data.expires_in || 3600;

                        // 更新账户状态和token
                        this.updateAccountStatus(accountId, 'authorized', {
                            access_token: accessToken,
                            expires_at: new Date(Date.now() + expiresIn * 1000).toISOString()
                        });

                        this.showToast('账户授权验证成功！', 'success');

                        // 自动开始邮件同步
                        setTimeout(() => {
                            this.syncAccountEmails(accountId);
                        }, 1000);

                        return { success: true, access_token: accessToken };

                    } else {
                        const errorData = await response.text();
                        console.error('Token验证失败:', response.status, errorData);

                        this.updateAccountStatus(accountId, 'reauth_needed');
                        this.showToast('授权验证失败，请检查凭据是否正确', 'error');

                        return { success: false, error: `HTTP ${response.status}` };
                    }

                } catch (error) {
                    console.error('验证账户授权失败:', error);
                    this.updateAccountStatus(accountId, 'reauth_needed');
                    this.showToast('授权验证失败: ' + error.message, 'error');
                    return { success: false, error: error.message };
                }
            }

            async handleOAuthCallback(accountId) {
                try {
                    // 更新进度
                    document.getElementById('oauthProgressText').textContent = '正在获取访问令牌...';
                    document.getElementById('oauthProgressFill').style.width = '60%';

                    // 这里应该处理OAuth回调并获取token
                    // 为了演示，我们模拟成功获取token
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // 模拟token数据
                    const mockTokens = {
                        access_token: 'mock_access_token_' + Date.now(),
                        refresh_token: 'mock_refresh_token_' + Date.now(),
                        expires_at: new Date(Date.now() + 3600 * 1000).toISOString()
                    };

                    // 更新账户状态
                    this.updateAccountStatus(accountId, 'authorized', mockTokens);

                    // 添加一些示例验证码
                    this.addVerificationCode(accountId, '123456', 'Microsoft', new Date().toISOString());

                    document.getElementById('oauthProgressFill').style.width = '100%';
                    document.getElementById('oauthProgressText').textContent = '授权完成！';

                    setTimeout(() => {
                        document.getElementById('oauthModal').style.display = 'none';
                        this.showToast('授权成功！', 'success');
                        this.render();
                        this.updateStats();
                    }, 1500);

                } catch (error) {
                    console.error('处理OAuth回调失败:', error);
                    this.showToast('授权失败: ' + error.message, 'error');
                    document.getElementById('oauthModal').style.display = 'none';
                }
            }

            // 同步邮件
            async syncAccountEmails(accountId) {
                const account = this.accounts.find(acc => acc.id === accountId);
                if (!account || account.status !== 'authorized' || !account.access_token) {
                    throw new Error('账户未授权或无效');
                }

                try {
                    this.showToast('正在同步邮件...', 'info');

                    // 调用Outlook REST API获取邮件
                    const emails = await this.fetchOutlookEmails(account.access_token);

                    // 提取验证码
                    const extractedCodes = this.extractVerificationCodes(emails);

                    // 添加新验证码
                    let newCodesCount = 0;
                    for (const codeData of extractedCodes) {
                        const exists = account.codes.some(code =>
                            code.code === codeData.code &&
                            code.sender === codeData.sender &&
                            code.messageId === codeData.messageId
                        );

                        if (!exists) {
                            this.addVerificationCode(
                                accountId,
                                codeData.code,
                                codeData.sender,
                                codeData.received_at
                            );
                            newCodesCount++;
                        }
                    }

                    account.last_sync = new Date().toISOString();
                    this.saveAccounts();

                    if (newCodesCount > 0) {
                        this.showToast(`同步完成，发现 ${newCodesCount} 个新验证码`, 'success');
                    } else {
                        this.showToast('同步完成，未发现新验证码', 'info');
                    }

                    return newCodesCount;

                } catch (error) {
                    console.error('同步邮件失败:', error);

                    // 如果token过期，尝试重新验证
                    if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                        this.updateAccountStatus(accountId, 'reauth_needed');
                        this.showToast('访问令牌已过期，请重新授权', 'warning');
                    } else {
                        this.showToast('同步邮件失败: ' + error.message, 'error');
                    }

                    throw error;
                }
            }

            // 调用Outlook REST API获取邮件
            async fetchOutlookEmails(accessToken) {
                // 使用代理服务器调用Outlook API
                const PROXY_URL = 'http://localhost:3001/api/outlook/api/v2.0/me/messages?$orderby=ReceivedDateTime desc&$top=5';

                const response = await fetch(PROXY_URL, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Outlook API调用失败: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                return data.value || [];
            }

            // 从邮��中提取验证码（与原系统相同的算法）
            extractVerificationCodes(messages) {
                const verificationCodes = [];
                const verificationPatterns = [
                    // 常见的验证码模式
                    /\b\d{4,8}\b/g,  // 4-8位数字
                    /(?:code|verification|验证码)[\s:：]*(\d{4,8})/gi,
                    /(?:verification code|验证码)[\s:：]*(\d{4,8})/gi,
                    /(?:pin|密码)[\s:：]*(\d{4,8})/gi,
                    // 邮件标题中的验证码
                    /^\[.*?(\d{4,8}).*?\]/gm,
                    // 包含"验证"的数字组合
                    /(?:验证|verification).*?(\d{4,8})/gi
                ];

                for (const message of messages) {
                    const subject = message.Subject || message.subject || '无标题';
                    const from = message.From || message.from;
                    const receivedDateTime = message.ReceivedDateTime || message.receivedDateTime;
                    const messageId = message.Id || message.id;
                    const bodyContent = message.Body?.Content || message.body?.content || '';

                    // 清理HTML内容，只保留文本
                    const cleanContent = bodyContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

                    // 在主题和内容中搜索验证码
                    const searchContent = `${subject} ${cleanContent}`;
                    const potentialCodes = [];

                    for (const pattern of verificationPatterns) {
                        const matches = [...searchContent.matchAll(pattern)];
                        for (const match of matches) {
                            const code = match[1] || match[0];
                            if (code && /^\d{4,8}$/.test(code)) {
                                potentialCodes.push(code);
                            }
                        }
                    }

                    // 验证码验证逻辑（与原系统保持一致）
                    for (const code of potentialCodes) {
                        // 跳过明显无效的数字
                        if (this.isValidVerificationCode(code, searchContent)) {
                            verificationCodes.push({
                                code: code,
                                subject: subject,
                                sender: from?.EmailAddress?.Name || from?.emailAddress || 'Unknown',
                                received_at: receivedDateTime,
                                messageId: messageId
                            });
                        }
                    }
                }

                // 去重（相同的验证码只保留最新的）
                const uniqueCodes = [];
                const seenCodes = new Set();

                for (const codeData of verificationCodes) {
                    const key = `${codeData.code}_${codeData.sender}`;
                    if (!seenCodes.has(key)) {
                        seenCodes.add(key);
                        uniqueCodes.push(codeData);
                    }
                }

                return uniqueCodes;
            }

            // 验证码有效性验证
            isValidVerificationCode(code, content) {
                // 跳过年份（如2024, 2023等）
                if (/^(19|20)\d{2}$/.test(code)) {
                    return false;
                }

                // 跳过电话号码格式
                if (code.startsWith('1') && code.length === 10) {
                    return false;
                }

                // 跳过常见的非验证码数字
                const invalidPatterns = [
                    /^000000/,  // 全零
                    /^123456/,  // 常见测试数字
                    /^111111/,
                    /^222222/
                ];

                if (invalidPatterns.some(pattern => pattern.test(code))) {
                    return false;
                }

                // 检查是否在验证相关的上下文中
                const verificationContexts = [
                    'verification', 'verify', 'code', '验证码', '验证', 'code',
                    'pin', 'password', '密码', 'otp', 'one-time', '一次性'
                ];

                const contentLower = content.toLowerCase();
                const hasVerificationContext = verificationContexts.some(context =>
                    contentLower.includes(context)
                );

                // 如果有验证上下文，或者代码长度为6位，则认为是有效的验证码
                return hasVerificationContext || code.length === 6;
            }

            // 批量导入
            handleBulkImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const accounts = this.parseAccountCSV(content);

                    if (accounts.length === 0) {
                        this.showToast('文件中没有找到有效的账户数据', 'warning');
                        return;
                    }

                    // 显示预览
                    this.showBulkImportPreview(accounts);
                    document.getElementById('selectedFileName').textContent = file.name;
                    document.getElementById('startBulkImport').disabled = false;
                };

                reader.readAsText(file);
            }

            parseAccountCSV(content) {
                const lines = content.split('\n');
                const accounts = [];
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed.startsWith('#')) continue; // 跳过空行和注释

                    // 支持CSV格式：email,client_id,refresh_token
                    const parts = trimmed.split(',').map(part => part.trim());

                    if (parts.length >= 3) {
                        const [email, clientId, refreshToken] = parts;

                        if (emailRegex.test(email) && clientId && refreshToken) {
                            accounts.push({
                                email: email,
                                client_id: clientId,
                                refresh_token: refreshToken,
                                name: email // 默认使用邮箱作为显示名称
                            });
                        }
                    }
                }

                // 去重（基于邮箱地址）
                const uniqueAccounts = [];
                const seenEmails = new Set();

                for (const account of accounts) {
                    if (!seenEmails.has(account.email)) {
                        seenEmails.add(account.email);
                        uniqueAccounts.push(account);
                    }
                }

                return uniqueAccounts;
            }

            showBulkImportPreview(accounts) {
                const previewList = document.getElementById('previewList');
                const previewAccounts = accounts.slice(0, 10);

                previewList.innerHTML = previewAccounts.map(account =>
                    `<div style="padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <div style="font-weight: 500;">${account.name}</div>
                        <div style="font-size: 12px; color: #6c757d;">${account.email}</div>
                        <div style="font-size: 11px; color: #999;">Client ID: ${account.client_id.substring(0, 10)}...</div>
                    </div>`
                ).join('');

                if (accounts.length > 10) {
                    previewList.innerHTML += `
                        <div style="padding: 8px 0; color: #6c757d; font-style: italic;">
                            ... 还有 ${accounts.length - 10} 个账户
                        </div>
                    `;
                }

                document.getElementById('bulkImportPreview').style.display = 'block';
            }

            async startBulkImport() {
                const fileInput = document.getElementById('bulkImportFile');
                const file = fileInput.files[0];

                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;
                    const accounts = this.parseAccountCSV(content);

                    if (accounts.length === 0) {
                        this.showToast('文件中没有找到有效的账户数据', 'warning');
                        return;
                    }

                    await this.performBulkImport(accounts);
                };

                reader.readAsText(file);
            }

            async performBulkImport(accounts) {
                const progressSection = document.getElementById('bulkImportProgress');
                const progressFill = document.getElementById('importProgressFill');
                const statusText = document.getElementById('importStatusText');

                progressSection.style.display = 'block';
                document.getElementById('startBulkImport').disabled = true;

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < accounts.length; i++) {
                    const accountData = accounts[i];
                    const progress = ((i + 1) / accounts.length) * 100;

                    try {
                        // 检查是否已存在
                        if (this.accounts.some(acc => acc.email === accountData.email)) {
                            errors.push(`${accountData.email}: 账户已存在`);
                            errorCount++;
                        } else {
                            // 添加账户
                            const account = this.addAccount(
                                accountData.email,
                                accountData.name,
                                accountData.client_id,
                                accountData.refresh_token
                            );
                            successCount++;

                            // 自动验证授权（异步，不阻塞导入过程）
                            setTimeout(() => {
                                this.validateAccountAuth(account.id);
                            }, 1000 * i); // 错开验证时间
                        }
                    } catch (error) {
                        errors.push(`${accountData.email}: ${error.message}`);
                        errorCount++;
                    }

                    // 更新进度
                    progressFill.style.width = `${progress}%`;
                    statusText.textContent = `正在导入 ${i + 1}/${accounts.length} (成功: ${successCount}, 失败: ${errorCount})`;
                }

                // 完成导入
                await this.saveAccounts();
                this.filteredAccounts = [...this.accounts];
                this.render();
                this.updateStats();
                this.updateStorageIndicator();

                // 显示结果
                const message = `批量导入完成！\n成功: ${successCount}\n失败: ${errorCount}`;
                if (errorCount > 0) {
                    console.warn('导入错误:', errors);
                    this.showToast(message, 'warning');
                } else {
                    this.showToast(message, 'success');
                }

                // 重置界面
                setTimeout(() => {
                    this.closeBulkImport();
                }, 3000);
            }

            closeBulkImport() {
                document.getElementById('bulkImportSection').style.display = 'none';
                document.getElementById('bulkImportFile').value = '';
                document.getElementById('selectedFileName').textContent = '未选择文件';
                document.getElementById('startBulkImport').disabled = true;
                document.getElementById('bulkImportPreview').style.display = 'none';
                document.getElementById('bulkImportProgress').style.display = 'none';
            }

            // 导出数据
            exportData() {
                if (this.accounts.length === 0) {
                    this.showToast('暂无数据可导出', 'warning');
                    return;
                }

                const exportData = {
                    accounts: this.accounts,
                    export_time: new Date().toISOString(),
                    version: '2.0',
                    statistics: {
                        total_accounts: this.accounts.length,
                        authorized_accounts: this.accounts.filter(acc => acc.status === 'authorized').length,
                        total_codes: this.accounts.reduce((sum, acc) => sum + acc.codes.length, 0)
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mailmanager_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showToast('数据导出成功', 'success');
            }

            // 定期同步
            startPeriodicSync() {
                // 每5分钟检查一次需要同步的账户
                setInterval(() => {
                    this.autoSyncAccounts();
                }, 5 * 60 * 1000);

                // 每小时检查token过期
                setInterval(() => {
                    this.checkTokenExpiry();
                }, 60 * 60 * 1000);
            }

            async autoSyncAccounts() {
                const authorizedAccounts = this.accounts.filter(acc => acc.status === 'authorized');
                const syncInterval = 30 * 60 * 1000; // 30分钟

                for (const account of authorizedAccounts) {
                    const lastSync = account.last_sync ? new Date(account.last_sync).getTime() : 0;
                    const now = Date.now();

                    if (now - lastSync > syncInterval) {
                        try {
                            await this.syncAccountEmails(account.id);
                            console.log(`自动同步账户: ${account.email}`);
                        } catch (error) {
                            console.error(`自动同步失败 ${account.email}:`, error);
                        }
                    }
                }
            }

            checkTokenExpiry() {
                const now = Date.now();
                const expiryThreshold = 24 * 60 * 60 * 1000; // 24小时

                for (const account of this.accounts) {
                    if (account.access_token && account.token_expires_at) {
                        const expiryTime = new Date(account.token_expires_at).getTime();

                        if (expiryTime - now < expiryThreshold) {
                            this.updateAccountStatus(account.id, 'reauth_needed');
                            console.log(`账户需要重新授权: ${account.email}`);
                        }
                    }
                }
            }

            // 工具方法
            getStatusText(status) {
                const statusMap = {
                    'authorized': '已授权',
                    'pending': '待授权',
                    'reauth_needed': '需重新授权'
                };
                return statusMap[status] || '未知';
            }

            formatTime(timeString) {
                if (!timeString) return '---';

                const date = new Date(timeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return '刚刚';
                if (diffMins < 60) return `${diffMins}分钟前`;
                if (diffHours < 24) return `${diffHours}小时前`;
                if (diffDays < 7) return `${diffDays}天前`;

                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span>${message}</span>
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }
        }

        // 全局实例
        let mailManager;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            mailManager = new BrowserMailManager();
        });

        // 全局函数
        function openAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'block';
            document.getElementById('newAccountEmail').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addAccount(event) {
            event.preventDefault();

            const email = document.getElementById('newAccountEmail').value.trim();
            const name = document.getElementById('newAccountName').value.trim();
            const clientId = document.getElementById('newAccountClientId').value.trim();
            const refreshToken = document.getElementById('newAccountRefreshToken').value.trim();

            if (!email || !clientId || !refreshToken) {
                mailManager.showToast('请填写所有必填字段', 'error');
                return;
            }

            try {
                const account = mailManager.addAccount(email, name, clientId, refreshToken);
                mailManager.filteredAccounts = [...mailManager.accounts];
                mailManager.render();
                mailManager.updateStats();
                mailManager.updateStorageIndicator();

                closeModal('addAccountModal');
                document.getElementById('addAccountForm').reset();

                // 自动验证授权状态
                mailManager.validateAccountAuth(account.id);

            } catch (error) {
                mailManager.showToast(error.message, 'error');
            }
        }

        function openBulkImportModal() {
            document.getElementById('bulkImportSection').style.display = 'block';
        }

        function closeBulkImport() {
            mailManager.closeBulkImport();
        }

        function startBulkImport() {
            mailManager.startBulkImport();
        }

        function searchAccounts(query) {
            mailManager.searchAccounts(query);
        }

        function filterByStatus(status) {
            mailManager.filterByStatus(status);
        }

        function sortTable(field) {
            mailManager.sortTable(field);
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.account-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const accountId = checkbox.dataset.accountId;
                if (selectAll.checked) {
                    mailManager.selectedAccounts.add(accountId);
                } else {
                    mailManager.selectedAccounts.delete(accountId);
                }
            });
        }

        function toggleAccountSelection(accountId, isSelected) {
            if (isSelected) {
                mailManager.selectedAccounts.add(accountId);
            } else {
                mailManager.selectedAccounts.delete(accountId);
            }

            // 更新全选状态
            const allCheckboxes = document.querySelectorAll('.account-checkbox');
            const checkedCount = document.querySelectorAll('.account-checkbox:checked').length;
            document.getElementById('selectAll').checked = checkedCount === allCheckboxes.length;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(mailManager.filteredAccounts.length / mailManager.itemsPerPage);
            const newPage = mailManager.currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                mailManager.currentPage = newPage;
                mailManager.render();
            }
        }

        function syncAccount(accountId) {
            const account = mailManager.accounts.find(acc => acc.id === accountId);
            if (!account) return;

            if (account.status !== 'authorized') {
                mailManager.startOAuthFlow(accountId);
                return;
            }

            // 显示同步进度
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> 同步中';
            btn.disabled = true;

            mailManager.syncAccountEmails(accountId).then((codesCount) => {
                mailManager.render();
                mailManager.updateStats();
                mailManager.showToast(`同步完成，发现 ${codesCount} 个新验证码`, 'success');
            }).catch((error) => {
                mailManager.showToast('同步失败: ' + error.message, 'error');
            }).finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function reauthAccount(accountId) {
            mailManager.startOAuthFlow(accountId);
        }

        function deleteAccount(accountId) {
            const account = mailManager.accounts.find(acc => acc.id === accountId);
            if (!account) return;

            if (confirm(`确定要删除账户 "${account.name}" 吗？\n\n此操作将删除该账户的所有数据，包括验证码记录。`)) {
                mailManager.deleteAccount(accountId);
                mailManager.filteredAccounts = [...mailManager.accounts];
                mailManager.render();
                mailManager.updateStats();
                mailManager.updateStorageIndicator();
                mailManager.showToast('账户删除成功', 'success');
            }
        }

        function bulkSync() {
            const selectedAccounts = Array.from(mailManager.selectedAccounts);

            if (selectedAccounts.length === 0) {
                mailManager.showToast('请先选择要同步的账户', 'warning');
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            let completed = 0;

            selectedAccounts.forEach(accountId => {
                const account = mailManager.accounts.find(acc => acc.id === accountId);
                if (!account) return;

                if (account.status !== 'authorized') {
                    errorCount++;
                    completed++;
                    return;
                }

                // 异步同步每个账户
                mailManager.syncAccountEmails(accountId).then(() => {
                    successCount++;
                    completed++;

                    if (completed === selectedAccounts.length) {
                        mailManager.render();
                        mailManager.updateStats();
                        mailManager.showToast(
                            `批量同步完成！成功: ${successCount}, 失败: ${errorCount}`,
                            errorCount === 0 ? 'success' : 'warning'
                        );
                    }
                }).catch(() => {
                    errorCount++;
                    completed++;

                    if (completed === selectedAccounts.length) {
                        mailManager.render();
                        mailManager.updateStats();
                        mailManager.showToast(
                            `批量同步完成！成功: ${successCount}, 失败: ${errorCount}`,
                            'warning'
                        );
                    }
                });
            });
        }

        function exportData() {
            mailManager.exportData();
        }

        function refreshData() {
            mailManager.render();
            mailManager.updateStats();
            mailManager.updateStorageIndicator();
            mailManager.showToast('数据已刷新', 'success');
        }

        function startOAuth() {
            const email = document.getElementById('oauthEmail').textContent;
            const account = mailManager.accounts.find(acc => acc.email === email);
            if (account) {
                mailManager.startOAuthFlow(account.id);
            }
        }

        // OAuth回调处理 (需要在实际部署时配置正确的URL)
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (code && state) {
                // 处理OAuth成功回调
                console.log('OAuth回调:', { code, state });
                // 这里应该交换code获取token
                // 然后关闭弹窗并更新账户状态
                window.close();
            } else if (error) {
                // 处理OAuth错误
                console.error('OAuth错误:', error);
                window.close();
            }
        });
    </script>
</body>
</html>