<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailManager - 简化管理界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 拆分的CSS文件 -->
    <link rel="stylesheet" href="css/complete-styles.css?v=20251102-2">
    <link rel="stylesheet" href="css/components.css?v=20251102-2">
</head>
<body class="bg-gray-50">
    <!-- 主容器 -->
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- 头部 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-envelope mr-3"></i>MailManager
                    </h1>
                    <p class="text-lg text-gray-600 mt-2">简单高效的邮箱验证码管理</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showProxyModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-globe mr-1"></i>一键代理设置
                    </button>
                    <button onclick="showImportModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-file-import mr-1"></i>导入邮箱
                    </button>
                    <!-- 智能连接状态显示 -->
                    <div id="connectionStatus" class="connection-status-wrapper">
                        <!-- 正常状态：绿色背景 + "连接正常" -->
                        <!-- 异常状态：橙色背景 + "重新连接"（可点击） -->
                        <!-- 连接状态将由JavaScript动态更新 -->
                    </div>
                    <button onclick="confirmClearAllData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-trash-alt mr-1"></i>清空数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="stats-row" style="position: relative;">
            <div class="stat-item">
                <div class="stat-number" id="totalAccounts">0</div>
                <div class="stat-label">总账户数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-green-600" id="authorizedCount">0</div>
                <div class="stat-label">已授权</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-yellow-600" id="pendingCount">0</div>
                <div class="stat-label">待授权</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-red-600" id="failedCount">0</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-purple-600" id="monitoringCount">0</div>
                <div class="stat-label">监控中</div>
            </div>
            <!-- 系统功能和安全说明 - 在统计行右侧空白处 -->
            <div class="system-info" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); max-width: 600px;">
                <div style="display: flex; gap: 30px;">
                    <!-- 核心功能 -->
                    <div>
                        <div style="display: flex; align-items: center; font-size: 16px; color: #374151; margin-bottom: 6px;">
                            <i class="fas fa-star" style="color: #f59e0b; margin-right: 8px; font-size: 14px;"></i>
                            <span style="font-weight: 600;">核心功能:</span>
                        </div>
                        <div style="font-size: 14px; color: #6b7280; line-height: 1.5; margin-left: 22px;">
                            <div>• 一键复制邮箱，自动监控更新验证码</div>
                            <div>• 一键复制验证码，快速完成验证</div>
                            <div>• 智能时间追踪，掌握邮箱活跃状态</div>
                        </div>
                    </div>

                    <!-- 数据安全 -->
                    <div>
                        <div style="display: flex; align-items: center; font-size: 16px; color: #374151; margin-bottom: 6px;">
                            <i class="fas fa-shield-alt" style="color: #10b981; margin-right: 8px; font-size: 14px;"></i>
                            <span style="font-weight: 600;">数据安全:</span>
                        </div>
                        <div style="font-size: 14px; color: #6b7280; line-height: 1.5; margin-left: 22px;">
                            <div>• 本地存储，数据仅保存在浏览器</div>
                            <div>• 加密保护，敏感信息安全存储</div>
                            <div>• 隐私安全，绝不上传任何服务器</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索和过滤 -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex gap-4 items-center flex-wrap">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">搜索:</label>
                    <input type="text" id="searchInput" placeholder="邮箱地址"
                           class="search-filter" onkeyup="filterAccounts()">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">状态:</label>
                    <select id="statusFilter" class="search-filter" onchange="filterAccounts()">
                        <option value="">全部</option>
                        <option value="pending">待授权</option>
                        <option value="authorized">已授权</option>
                        <option value="reauth_needed">需重新授权</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">每页显示:</label>
                    <select id="pageSize" class="search-filter" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 账户列表 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-20" onclick="sortBySequence()">
                                <span class="flex items-center gap-1">
                                    序号
                                    <i id="seqSortIcon" class="fas fa-sort text-gray-400"></i>
                                </span>
                            </th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-20" onclick="sortByStatus()">
                                <span class="flex items-center gap-1">
                                    状态
                                    <i id="statusSortIcon" class="fas fa-sort text-gray-400"></i>
                                </span>
                            </th>
                            <th class="px-4 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-34" onclick="sortByEmail()">
                                <span class="flex items-center gap-1">
                                    邮箱地址
                                    <i id="emailSortIcon" class="fas fa-sort text-gray-400"></i>
                                </span>
                            </th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider w-16">选中</th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider w-32">最新验证码</th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-36" onclick="sortByCodeTime()">
                                <span class="flex items-center gap-1">
                                    验证码时间
                                    <i id="codeTimeSortIcon" class="fas fa-sort text-gray-400"></i>
                                </span>
                            </th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-28" onclick="sortBySender()">
                                <span class="flex items-center gap-1">
                                    发件人
                                    <i id="senderSortIcon" class="fas fa-sort text-gray-400"></i>
                                </span>
                            </th>
                            <th class="px-3 py-3 text-left text-base font-medium text-gray-700 uppercase tracking-wider w-64">操作</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 账户数据将在这里加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页控制 -->
            <div class="px-6 py-4 border-t bg-gray-50">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-700">
                        显示 <span id="showingFrom">0</span> - <span id="showingTo">0</span>
                        共 <span id="totalRecords">0</span> 条记录
                    </div>
                    <div class="simple-pagination" id="pagination">
                        <!-- 分页按钮将在这里生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入邮箱弹窗 -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 modal-hidden hidden items-center justify-center" style="z-index: 1050;">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-file-import mr-2"></i>导入邮箱
                </h2>
                <button onclick="hideImportModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    邮箱信息格式
                </label>
                <div class="bg-gray-50 p-3 rounded border text-sm text-gray-600 mb-4">
                    格式：邮箱地址----密码----Client ID----Refresh Token<br>
                    （每行一个邮箱信息，使用四个----分隔，支持智能UUID识别）<br>
                    <span class="text-amber-600 font-medium">💡 建议一次导入不超过1000个邮箱，以确保最佳性能</span>
                </div>

                <label class="block text-sm font-medium text-gray-700 mb-2">
                    请输入邮箱信息（一行一个）
                </label>
                <textarea
                    id="importTextarea"
                    rows="10"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="example@outlook.com----password123----client_id_value----refresh_token_value&#10;user2@outlook.com----password456----client_id_2----refresh_token_2"
                ></textarea>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="hideImportModal()"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                    取消
                </button>
                <button onclick="importEmails()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-file-import mr-1"></i>导入邮箱
                </button>
            </div>
        </div>
    </div>

    <!-- 导入进度弹窗 -->
    <div id="importProgressModal" class="fixed inset-0 bg-black bg-opacity-50 modal-hidden hidden items-center justify-center" style="z-index: 1050;">
        <div class="bg-white rounded-lg p-6 w-96">
            <!-- 导入中状态 -->
            <div id="importingStatus">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-spinner fa-spin mr-2"></i>正在导入邮箱
                </h3>
                <div class="mb-4">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2" id="progressText">准备导入...</p>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="progressCount">0/0</span> 个邮箱
                </div>
            </div>

            <!-- 完成状态 -->
            <div id="importCompleteStatus" class="hidden">
                <div class="text-center mb-4">
                    <div class="inline-block bg-green-100 rounded-full p-3">
                        <i class="fas fa-check text-green-500 text-2xl"></i>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2 text-center">导入完成</h3>
                <div class="mb-4 text-center">
                    <p class="text-gray-700" id="importResultText"></p>
                </div>
            </div>

            <!-- 关闭按钮 -->
            <div id="importCloseButton" class="hidden">
                <button onclick="closeImportProgressModal()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 一键代理设置弹窗 -->
    <div id="proxyModal" class="fixed inset-0 bg-black bg-opacity-50 modal-hidden hidden items-center justify-center" style="z-index: 1050;">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-globe mr-2"></i>一键代理设置
                </h2>
                <button onclick="hideProxyModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- 代理URL输入区域 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    代理URL配置
                </label>
                <div class="bg-gray-50 p-3 rounded border text-sm text-gray-600 mb-4">
                    格式：https://api.provider.com/api?username=用户名&password=密码&ips=1&type=-res-&proxyType=http&responseType=txt<br>
                    <span class="text-amber-600 font-medium">💡 请确保URL包含username、password和固定参数</span>
                </div>

                <label class="block text-sm font-medium text-gray-700 mb-2">
                    代理URL:
                </label>
                <input
                    type="url"
                    id="proxyUrlInput"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="https://api.iprocket.io/api?username=your_username&password=your_password&cc=ROW&ips=1&type=-res-&proxyType=http&responseType=txt"
                    value=""
                >
                <div id="proxyUrlError" class="mt-2 text-sm text-red-600 hidden"></div>
            </div>

            <!-- 生成代理IP按钮 -->
            <div class="mb-6">
                <button onclick="generateProxyIP()" id="generateProxyBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition font-medium">
                    <i class="fas fa-download mr-2"></i>生成代理IP
                </button>
            </div>

            <!-- 代理IP显示区域 -->
            <div id="proxyResultSection" class="mb-6 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    获得的代理IP:
                </label>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <span class="text-sm text-gray-600">代理服务器:</span>
                            <div class="font-mono font-medium" id="proxyHost">-</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">端口:</span>
                            <div class="font-mono font-medium" id="proxyPort">-</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">用户名:</span>
                            <div class="font-mono font-medium text-sm break-all" id="proxyUsername">-</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">密码:</span>
                            <div class="font-mono font-medium text-sm break-all" id="proxyPassword">-</div>
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <div class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            完整代理地址: <span id="fullProxyAddress" class="font-mono">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮区域 -->
            <div id="proxyActionsSection" class="hidden">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <button onclick="configureSystemProxy()" id="configureProxyBtn"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition font-medium">
                        <i class="fas fa-cog mr-2"></i>一键配置代理
                    </button>
                    <button onclick="verifyProxyIP()" id="verifyProxyBtn"
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg transition font-medium">
                        <i class="fas fa-external-link-alt mr-2"></i>验证IP地址
                    </button>
                </div>

                <!-- 配置状态显示 -->
                <div id="proxyStatusMessage" class="hidden"></div>
            </div>

            <!-- 关闭按钮 -->
            <div class="flex justify-end">
                <button onclick="hideProxyModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 清空数据确认弹窗 -->
    <div id="clearDataModal" class="fixed inset-0 bg-black bg-opacity-50 modal-hidden hidden items-center justify-center" style="z-index: 1050;">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="text-center">
                <div class="mb-4">
                    <div class="inline-block bg-red-100 rounded-full p-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">确认清空所有数据</h3>
                <div class="text-sm text-gray-600 mb-6">
                    此操作将永久删除所有邮箱账户、验证码和消息记录，<br>
                    包括邮箱配置、验证码历史、导入记录等所有数据。<br><br>
                    <strong class="text-red-600">此操作不可恢复！</strong><br>
                    请确认您真的要继续吗？
                </div>

                <div class="mb-4">
                    <label class="flex items-center justify-center text-sm text-gray-700">
                        <input type="checkbox" id="confirmCheckbox" class="mr-2" onchange="updateConfirmButton()">
                        我确认要清空所有数据，并了解此操作不可恢复
                    </label>
                </div>

                <div class="flex gap-3 justify-center">
                    <button onclick="hideClearDataModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        取消
                    </button>
                    <button
                        id="confirmClearButton"
                        onclick="clearAllData()"
                        disabled
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-trash-alt mr-1"></i>确认清空
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 文件加载 -->
    <script src="js/core/utils.js?v=20251102-6"></script>
    <script src="js/core/SimpleMailManager.js?v=20251103-36"></script>
    <script src="js/global-functions.js?v=20251104-10"></script>

    <!-- 初始化脚本 -->
    <script>
        // 全局实例
        let manager;

        // 初始化 - 确保模态框隐藏
        document.addEventListener('DOMContentLoaded', () => {
            // 强制隐藏所有弹窗 - 使用style和CSS类双重保险
            ['importModal', 'importProgressModal', 'clearDataModal', 'proxyModal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('modal-hidden', 'hidden');
                    element.style.display = 'none';
                }
            });

   
            // 防止重复初始化
            if (window.mailManagerInstance && window.manager) {
                return;
            }

            manager = new SimpleMailManager();
            window.mailManagerInstance = manager; // 防止重复创建实例
            window.manager = manager; // 导入函数需要访问manager
            // 检查是否为OAuth回调
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('code') || urlParams.has('error')) {
                    manager.handleOAuthCallback();
                }
            }, 500); // 延迟500ms确保管理器完全初始化
        });
    </script>
</body>
</html>