# é‚®ä»¶è·å–ç­–ç•¥åˆ†ææŠ¥å‘Š

## ğŸ” é—®é¢˜åˆ†æ

**ç”¨æˆ·å…³åˆ‡**ï¼šå¤åˆ¶é‚®ç®±åè§¦å‘ç›‘æ§ï¼Œæ˜¯å¦ä¼šæ‹‰å–å†å²é‡å¤çš„é‚®ä»¶ï¼Ÿè¿™ç§è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ

## ğŸ“Š å½“å‰é‚®ä»¶è·å–ç­–ç•¥å¯¹æ¯”

### 1. å¤åˆ¶é‚®ç®±è§¦å‘ç›‘æ§ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰

**ç‰¹ç‚¹**ï¼šâœ… **æ™ºèƒ½é˜²é‡å¤è®¾è®¡**

```javascript
// ç›‘æ§å¼€å§‹æ—¶é—´è®°å½•
monitor_start_time: new Date().toISOString()

// åªè·å–æ–°é‚®ä»¶æ¨¡å¼
const fetchOptions = accountInfo._just_reauthorized ?
    { onlyNew: true, sinceTime: accountInfo.monitor_start_time || new Date(Date.now() - 15000).toISOString() } :
    { onlyNew: true };

// APIæŸ¥è¯¢æ·»åŠ æ—¶é—´è¿‡æ»¤
if (onlyNew && sinceTime) {
    query += `&$filter=ReceivedDateTime ge ${sinceISO}`;
}
```

**é‚®ä»¶è·å–é€»è¾‘**ï¼š
- âœ… **åªè·å–ç›‘æ§å¼€å§‹åçš„æ–°é‚®ä»¶**
- âœ… **é¿å…æ‹‰å–å†å²é‡å¤é‚®ä»¶**
- âœ… **åŸºäºæ—¶é—´æˆ³è¿‡æ»¤**ï¼š`ReceivedDateTime ge ç›‘æ§å¼€å§‹æ—¶é—´`

### 2. æ‰‹åŠ¨å–ä»¶ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¨¡å¼ï¼‰

**ç‰¹ç‚¹**ï¼šâš ï¸ **å…¨é‡è·å–å†å²é‚®ä»¶**

```javascript
// è·å–æœ€è¿‘5å°é‚®ä»¶ï¼Œä¸å—æ—¶é—´é™åˆ¶
const emailResponse = await fetch('https://outlook.office.com/api/v2.0/me/messages?$top=5&$orderby=ReceivedDateTime desc', {
    headers: {
        'Authorization': `Bearer ${tokenData.access_token}`,
        'Accept': 'application/json'
    }
});
```

**é‚®ä»¶è·å–é€»è¾‘**ï¼š
- âš ï¸ **è·å–æœ€è¿‘5å°é‚®ä»¶**
- âš ï¸ **åŒ…å«å†å²é‚®ä»¶**
- âš ï¸ **å¯èƒ½é‡å¤è·å–å·²å¤„ç†çš„é‚®ä»¶**

## ğŸ¯ ç­–ç•¥åˆç†æ€§åˆ†æ

### âœ… å¤åˆ¶é‚®ç®±ç›‘æ§ï¼ˆåˆç†è®¾è®¡ï¼‰

**è®¾è®¡ç†å¿µ**ï¼š
1. **å®æ—¶æ€§ä¼˜å…ˆ**ï¼šç”¨æˆ·å¤åˆ¶é‚®ç®±é€šå¸¸æ˜¯ä¸ºäº†è·å–æœ€æ–°çš„éªŒè¯ç 
2. **é¿å…é‡å¤**ï¼šåªè·å–ç›‘æ§å¼€å§‹åçš„æ–°é‚®ä»¶ï¼Œé¿å…é‡å¤å¤„ç†
3. **æ•ˆç‡ä¼˜åŒ–**ï¼šå‡å°‘ä¸å¿…è¦çš„é‚®ä»¶å¤„ç†å’ŒéªŒè¯ç é‡å¤æå–
4. **ç”¨æˆ·å‹å¥½**ï¼šç”¨æˆ·çœ‹åˆ°çš„æ˜¯çœŸæ­£çš„æ–°å†…å®¹

**å®ç°æœºåˆ¶**ï¼š
- ç›‘æ§å¼€å§‹æ—¶é—´æˆ³ä½œä¸ºåŸºå‡†
- APIæŸ¥è¯¢æ—¶ä½¿ç”¨æ—¶é—´è¿‡æ»¤å‚æ•°
- åªè·å–åœ¨ç›‘æ§å¼€å§‹åæ”¶åˆ°çš„é‚®ä»¶

### âš ï¸ æ‰‹åŠ¨å–ä»¶ï¼ˆéœ€è¦æƒè¡¡ï¼‰

**è®¾è®¡ç†å¿µ**ï¼š
1. **å®Œæ•´æ€§ä¼˜å…ˆ**ï¼šç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æœ€è¿‘çš„éªŒè¯ç 
2. **ç®€å•å¯é **ï¼šä¸ä¾èµ–æ—¶é—´è¿‡æ»¤ï¼Œé¿å…æ—¶åŒºç­‰é—®é¢˜
3. **è¦†ç›–å…¨é¢**ï¼šç¡®ä¿é‡è¦éªŒè¯ç ä¸ä¼šè¢«é—æ¼

**æ½œåœ¨é—®é¢˜**ï¼š
- å¯èƒ½é‡å¤æ˜¾ç¤ºå·²å¤„ç†çš„éªŒè¯ç 
- ç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°ç›¸åŒçš„éªŒè¯ç å¤šæ¬¡
- å¢åŠ äº†ä¸å¿…è¦çš„å¤„ç†å¼€é”€

## ğŸ”§ ä¼˜åŒ–å»ºè®®

### æ–¹æ¡ˆ1ï¼šå¢å¼ºæ‰‹åŠ¨å–ä»¶çš„æ™ºèƒ½è¿‡æ»¤

```javascript
// å»ºè®®ä¼˜åŒ–ï¼šæ‰‹åŠ¨å–ä»¶ä¹Ÿè€ƒè™‘æ—¶é—´è¿‡æ»¤
const fetchManualEmails = async (account, lastSyncTime) => {
    let query = `$top=5&$orderby=ReceivedDateTime desc`;

    // å¦‚æœæœ‰ä¸Šæ¬¡åŒæ­¥æ—¶é—´ï¼Œæ·»åŠ æ—¶é—´è¿‡æ»¤
    if (lastSyncTime) {
        const lastSyncISO = new Date(lastSyncTime).toISOString();
        query += `&$filter=ReceivedDateTime ge ${lastSyncISO}`;
    }

    // å¦‚æœæ—¶é—´è¿‡æ»¤åé‚®ä»¶ä¸è¶³5å°ï¼Œåˆ™å›é€€åˆ°å…¨é‡è·å–
    const response = await fetch(`https://outlook.office.com/api/v2.0/me/messages?${query}`, {...});

    let emails = await response.json();
    if (emails.value.length < 5 && lastSyncTime) {
        // å›é€€ï¼šè·å–æœ€è¿‘5å°é‚®ä»¶ï¼ˆåŒ…å«å†å²ï¼‰
        const fallbackResponse = await fetch('https://outlook.office.com/api/v2.0/me/messages?$top=5&$orderby=ReceivedDateTime desc', {...});
        emails = await fallbackResponse.json();
    }

    return emails;
};
```

### æ–¹æ¡ˆ2ï¼šéªŒè¯ç å»é‡æœºåˆ¶

```javascript
// å‰ç«¯å»é‡é€»è¾‘
handleVerificationCodeFound(data) {
    const account = this.accounts.find(acc => acc.id === data.account_id);
    if (!account) return;

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„éªŒè¯ç 
    const isDuplicate = account.codes?.some(existingCode =>
        existingCode.code === data.code &&
        existingCode.sender === data.sender &&
        existingCode.received_at === data.received_at
    );

    if (isDuplicate) {
        console.log(`[å»é‡] è·³è¿‡é‡å¤éªŒè¯ç : ${data.code}`);
        return;
    }

    // æ·»åŠ æ–°éªŒè¯ç 
    account.codes.unshift({
        code: data.code,
        sender: data.sender,
        received_at: data.received_at,
        score: data.score || 1.0
    });

    // ... å…¶ä½™å¤„ç†é€»è¾‘
}
```

### æ–¹æ¡ˆ3ï¼šç”¨æˆ·é…ç½®é€‰é¡¹

```javascript
// åœ¨è®¾ç½®ä¸­æ·»åŠ é‚®ä»¶è·å–ç­–ç•¥é€‰é¡¹
const emailFetchSettings = {
    copyMonitoring: {
        mode: 'new_only',        // åªè·å–æ–°é‚®ä»¶
        timeWindow: 300,         // 5åˆ†é’Ÿæ—¶é—´çª—å£
        maxHistory: 0            // ä¸è·å–å†å²é‚®ä»¶
    },
    manualFetch: {
        mode: 'smart_filter',    // æ™ºèƒ½è¿‡æ»¤æ¨¡å¼
        timeWindow: 3600,        // 1å°æ—¶æ—¶é—´çª—å£
        maxHistory: 5,           // æœ€å¤š5å°å†å²é‚®ä»¶
        fallback: 'if_needed'    // éœ€è¦æ—¶å›é€€åˆ°å…¨é‡
    }
};
```

## ğŸ“‹ å½“å‰è¯„ä¼°ç»“è®º

### âœ… å¤åˆ¶é‚®ç®±ç›‘æ§è®¾è®¡**ï¼š**ä¼˜ç§€**
- é¿å…é‡å¤é‚®ä»¶ âœ…
- å®æ—¶æ€§å¼º âœ…
- æ•ˆç‡ä¼˜åŒ– âœ…
- ç”¨æˆ·ä½“éªŒä½³ âœ…

### âš ï¸ æ‰‹åŠ¨å–ä»¶è®¾è®¡**ï¼š**å¯ä¼˜åŒ–**
- åŠŸèƒ½å®Œæ•´ä½†å¯èƒ½é‡å¤ âš ï¸
- å»ºè®®å¢åŠ æ™ºèƒ½è¿‡æ»¤ âš ï¸
- å¯ä»¥æ·»åŠ å»é‡æœºåˆ¶ âš ï¸

## ğŸ¯ æ¨èè¡ŒåŠ¨

1. **ä¿æŒç°æœ‰ç›‘æ§ç­–ç•¥**ï¼šå¤åˆ¶é‚®ç®±çš„ç›‘æ§é€»è¾‘è®¾è®¡è‰¯å¥½ï¼Œæ— éœ€ä¿®æ”¹
2. **ä¼˜åŒ–æ‰‹åŠ¨å–ä»¶**ï¼šè€ƒè™‘å¢åŠ æ—¶é—´è¿‡æ»¤å’Œå»é‡æœºåˆ¶
3. **å¢å¼ºç”¨æˆ·åé¦ˆ**ï¼šæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·è·å–çš„æ˜¯æ–°é‚®ä»¶è¿˜æ˜¯å†å²é‚®ä»¶
4. **æä¾›é…ç½®é€‰é¡¹**ï¼šè®©ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´é‚®ä»¶è·å–ç­–ç•¥

---
**æ€»ç»“**ï¼šå¤åˆ¶é‚®ç®±è§¦å‘ç›‘æ§çš„é‚®ä»¶è·å–ç­–ç•¥è®¾è®¡åˆç†ï¼Œæœ‰æ•ˆé¿å…äº†å†å²é‡å¤é‚®ä»¶çš„é—®é¢˜ï¼Œå€¼å¾—ä¿æŒç°æœ‰è®¾è®¡ã€‚