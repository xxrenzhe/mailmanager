<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokenè¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">ğŸ” Tokenè¯Šæ–­å·¥å…·</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">å­˜å‚¨çš„è´¦æˆ·ä¿¡æ¯</h2>
            <div id="accounts-info" class="space-y-4">
                <p class="text-gray-500">æ­£åœ¨åŠ è½½...</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">Tokenåˆ·æ–°æµ‹è¯•</h2>
            <button onclick="testTokenRefresh()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                æµ‹è¯•Tokenåˆ·æ–°
            </button>
            <div id="test-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        // åŠ è½½è´¦æˆ·ä¿¡æ¯
        function loadAccounts() {
            const stored = localStorage.getItem('mailmanager_accounts');
            const accountsDiv = document.getElementById('accounts-info');

            if (!stored) {
                accountsDiv.innerHTML = '<p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·æ•°æ®</p>';
                return;
            }

            try {
                const accounts = JSON.parse(stored);
                let html = '';

                accounts.forEach((account, index) => {
                    const tokenLength = account.refresh_token ? account.refresh_token.length : 0;
                    const tokenPrefix = account.refresh_token ? account.refresh_token.substring(0, 20) : '';
                    const statusColor = account.status === 'authorized' ? 'green' : 'red';

                    html += `
                        <div class="border rounded p-4">
                            <h3 class="font-semibold">${account.email}</h3>
                            <p><span class="text-gray-600">çŠ¶æ€:</span> <span style="color: ${statusColor}">${account.status}</span></p>
                            <p><span class="text-gray-600">Client ID:</span> ${account.client_id ? account.client_id.substring(0, 8) + '...' : 'null'}</p>
                            <p><span class="text-gray-600">Refresh Tokené•¿åº¦:</span> ${tokenLength}</p>
                            <p><span class="text-gray-600">Refresh Tokenå‰ç¼€:</span> ${tokenPrefix}...</p>
                            <p><span class="text-gray-600">æœ€åæ£€æŸ¥:</span> ${account.last_check || 'æœªçŸ¥'}</p>
                        </div>
                    `;
                });

                accountsDiv.innerHTML = html;
            } catch (error) {
                accountsDiv.innerHTML = `<p class="text-red-500">è§£æè´¦æˆ·æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æµ‹è¯•Tokenåˆ·æ–°
        async function testTokenRefresh() {
            const resultDiv = document.getElementById('test-result');
            const stored = localStorage.getItem('mailmanager_accounts');

            if (!stored) {
                resultDiv.innerHTML = '<p class="text-red-500">æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·æ•°æ®</p>';
                return;
            }

            try {
                const accounts = JSON.parse(stored);
                const firstAccount = accounts[0];

                if (!firstAccount) {
                    resultDiv.innerHTML = '<p class="text-red-500">æ²¡æœ‰å¯æµ‹è¯•çš„è´¦æˆ·</p>';
                    return;
                }

                resultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨æµ‹è¯•Tokenåˆ·æ–°...</p>';

                const response = await fetch('https://www.mailmanager.dev/api/accounts/refresh-token-direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: firstAccount.client_id,
                        refresh_token: firstAccount.refresh_token
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <p class="font-semibold">âœ… Tokenåˆ·æ–°æˆåŠŸ!</p>
                            <p>æ–°Tokenæœ‰æ•ˆæœŸ: ${result.expires_in}ç§’</p>
                            <p>Tokenç±»å‹: ${result.token_type}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <p class="font-semibold">âŒ Tokenåˆ·æ–°å¤±è´¥</p>
                            <p>é”™è¯¯: ${result.error}</p>
                            <p>è¯¦æƒ…: ${result.details}</p>
                            <p class="text-sm mt-2">è¿™é€šå¸¸æ„å‘³ç€refresh_tokenå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°è·å–Microsoftæˆæƒ</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <p class="font-semibold">âŒ æµ‹è¯•å¤±è´¥</p>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadAccounts();
    </script>
</body>
</html>