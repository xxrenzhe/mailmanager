<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token诊断工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">🔍 Token诊断工具</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">存储的账户信息</h2>
            <div id="accounts-info" class="space-y-4">
                <p class="text-gray-500">正在加载...</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">Token刷新测试</h2>
            <button onclick="testTokenRefresh()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                测试Token刷新
            </button>
            <div id="test-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        // 加载账户信息
        function loadAccounts() {
            const stored = localStorage.getItem('mailmanager_accounts');
            const accountsDiv = document.getElementById('accounts-info');

            if (!stored) {
                accountsDiv.innerHTML = '<p class="text-gray-500">没有找到账户数据</p>';
                return;
            }

            try {
                const accounts = JSON.parse(stored);
                let html = '';

                accounts.forEach((account, index) => {
                    const tokenLength = account.refresh_token ? account.refresh_token.length : 0;
                    const tokenPrefix = account.refresh_token ? account.refresh_token.substring(0, 20) : '';
                    const statusColor = account.status === 'authorized' ? 'green' : 'red';

                    html += `
                        <div class="border rounded p-4">
                            <h3 class="font-semibold">${account.email}</h3>
                            <p><span class="text-gray-600">状态:</span> <span style="color: ${statusColor}">${account.status}</span></p>
                            <p><span class="text-gray-600">Client ID:</span> ${account.client_id ? account.client_id.substring(0, 8) + '...' : 'null'}</p>
                            <p><span class="text-gray-600">Refresh Token长度:</span> ${tokenLength}</p>
                            <p><span class="text-gray-600">Refresh Token前缀:</span> ${tokenPrefix}...</p>
                            <p><span class="text-gray-600">最后检查:</span> ${account.last_check || '未知'}</p>
                        </div>
                    `;
                });

                accountsDiv.innerHTML = html;
            } catch (error) {
                accountsDiv.innerHTML = `<p class="text-red-500">解析账户数据失败: ${error.message}</p>`;
            }
        }

        // 测试Token刷新
        async function testTokenRefresh() {
            const resultDiv = document.getElementById('test-result');
            const stored = localStorage.getItem('mailmanager_accounts');

            if (!stored) {
                resultDiv.innerHTML = '<p class="text-red-500">没有找到账户数据</p>';
                return;
            }

            try {
                const accounts = JSON.parse(stored);
                const firstAccount = accounts[0];

                if (!firstAccount) {
                    resultDiv.innerHTML = '<p class="text-red-500">没有可测试的账户</p>';
                    return;
                }

                resultDiv.innerHTML = '<p class="text-blue-500">正在测试Token刷新...</p>';

                const response = await fetch('https://www.mailmanager.dev/api/accounts/refresh-token-direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: firstAccount.client_id,
                        refresh_token: firstAccount.refresh_token
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <p class="font-semibold">✅ Token刷新成功!</p>
                            <p>新Token有效期: ${result.expires_in}秒</p>
                            <p>Token类型: ${result.token_type}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <p class="font-semibold">❌ Token刷新失败</p>
                            <p>错误: ${result.error}</p>
                            <p>详情: ${result.details}</p>
                            <p class="text-sm mt-2">这通常意味着refresh_token已过期，需要重新获取Microsoft授权</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <p class="font-semibold">❌ 测试失败</p>
                        <p>错误: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 页面加载时执行
        loadAccounts();
    </script>
</body>
</html>